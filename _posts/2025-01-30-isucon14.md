---
layout: post
title: ISUCON14の感想戦モードでRubyで六万点を獲得した
image: "/images/posts/isucon/isucon14.png"
description: 2024年末に ISUCON14 に参加した。競技終了後の感想戦モードでRubyで六万点を目指して無事獲得できたので記録を残しておく。
tags: isucon
---

2024年末に ISUCON14 に参加した。競技終了後の感想戦モードでRubyで六万点を目指して無事獲得できたので記録を残しておく。

<blockquote class="twitter-tweet"><p lang="ja" dir="ltr"><a href="https://twitter.com/hashtag/isucon?src=hash&amp;ref_src=twsrc%5Etfw">#isucon</a> のISUCON14 PORTALが今日まで遊べる、ということでRubyで六万点目指してちょびちょびイジって遊んでたんだけど最後に目標の六万いけたので満足 🥰 <a href="https://t.co/6YY3W94ZqE">pic.twitter.com/6YY3W94ZqE</a></p>&mdash; toshimaru (@toshimaru_e) <a href="https://twitter.com/toshimaru_e/status/1880097870642311482?ref_src=twsrc%5Etfw">January 17, 2025</a></blockquote>
<script async src="https://platform.twitter.com/widgets.js" charset="utf-8"></script>

## 参加経緯

ISUCONは毎年都合が合えば出たいとは思っているが、近年は人気アイドルのチケット争奪戦かってくらいの人気イベントになっているので、しばらく参加できずにいた。

しかし今年は[参加枠が大幅に増えた](https://isucon.net/archives/58653780.html)ようで、なんとか参加枠が確保できたので参加。ただ一人チーム + 競技当日予定ありの中参加したので、本気で勝利を目指すためというより勉強目的の参加だ。

<blockquote class="twitter-tweet"><p lang="ja" dir="ltr">今日はエンジョイ勢として <a href="https://twitter.com/hashtag/ISUCON?src=hash&amp;ref_src=twsrc%5Etfw">#ISUCON</a> 参加予定</p>&mdash; toshimaru (@toshimaru_e) <a href="https://twitter.com/toshimaru_e/status/1865556181894492462?ref_src=twsrc%5Etfw">December 8, 2024</a></blockquote>

## 参加してみての Good/Bad

当日は予定があって途中離脱したこともあり、最終スコアは全然伸びなかったけど全体を通して振り返りを書いておく。

### Good

- 今年のお題は＜タクシー配車アプリ＞。個人的にタクシー配車アプリに興味を持っていたこともあり、そのような要件に触れられて嬉しかった
- [当日マニュアル](https://gist.github.com/wtks/0a3268de13856ed6e18c6560023ec436)、[アプリケーションマニュアル](https://gist.github.com/wtks/8eadf471daf7cb59942de02273ce7884) を丁寧に読むように意識した。特にひっかかることなく実施 ・理解できたのはよかった
- エディタはZed(+ VSCode)の[Remote Development機能](https://zed.dev/docs/remote-development)を使った
  - 一人参加だったのでコードベースの競合を気にしなくていいのは良かった
- サーバーで `gh` コマンドをインストールして [gh auth login](https://cli.github.com/manual/gh_auth_login) して GitHub private repo と繋ぎ込んだ
- アクセスログの解析は nginx ログを [alp](https://github.com/tkuchiki/alp) に食わせて解析するのが良かった
  - 参考. alp の使い方 [alp/docs/usage_samples.md at main · tkuchiki/alp](https://github.com/tkuchiki/alp/blob/main/docs/usage_samples.md)
- 令和時代のクエリ分析は [pt-query-digest](https://docs.percona.com/percona-toolkit/pt-query-digest.html) ではなく、 MySQL Performance Schema の活用が良さそう
  - 実際の利用クエリはこちらを参照: [チーム白金動物園としてISUCON13に参加しました - 昼メシ物語](https://blog.mirakui.com/entry/2023/11/27/152107)
- SQLの書き換えやコードの部分的な置き換えはAIが活用できた
  - AIが現在進行系でできることがガンガン増えていて、今後その流れがものすごく加速しそうだと感じた

### Bad（反省点）

- [前回参加](/isucon7/)したときの反省として「サーバーの分散戦略の失敗」があったので、最初にアプリを分散させることにフォーカスしたが、これが結果的に良くなかった
  - 後述するエラーの発生要因になった
  - Aサーバーで行った変更をBサーバーに変更漏れしたり、「自分が今どのサーバーで作業をしているのか」を見失ったりして無駄に時間を浪費することになった
  - 今回ボトルネックは DB に比重が大きかったので、アプリケーションをいかに効率的に分散させるかは、初手に考えるべきではなかった
- スコアを伸ばすにあたって下記のエラーにひたすら頭を悩まされた
  - > 椅子がライドの完了通知を受け取る前に、別の新しいライドの通知を受け取りました
  - > 椅子に想定していないライドの状態遷移の通知がありました
  - サーバーを初手で分散させたことが原因
- カジュアルに使えるAPM SaaS として [Sentry APM](https://sentry.io/for/performance/) を使おうと思ったけど、役立たなかった
  - 上述した alp くらいのシンプルツールのほうが取り回しがよい

## 学習したこと

- マッチングアルゴリズム
  - タクシー x 乗客のマッチングアルゴリズムとして [Hungarian algorithm](https://en.wikipedia.org/wiki/Hungarian_algorithm) を利用しようと試みた
  - 実装してみたが、スコアが伸びなかった
  - 件数が多すぎるとマッチングに時間を要して、使い物にならず
    - 件数少ないときにHungarianを使うようにもしてみたが、結果的にスコアは伸びず...
- `jounalctrl` コマンド
  - `journalctl -f`
  - `jounalctrl --system`
  - `jounalctrl --user`
  - `journalctl -u nginx`
  - 場所は `/var/log/journal` に保存されている
- `systemctl` コマンド
  - `systemctl {status,restart,enable,disable} nginx`
  - 今回つかったやつ
    - `sudo systemctl start isuride-ruby`
    - `sudo systemctl enable isuride-ruby`
    - `sudo systemctl restart isuride-ruby`
    - `sudo systemctl restart mysql`
    - `sudo systemctl restart isuride-matcher`
- mysql 設定の変更点
  - bind-address: `0.0.0.0`
  - Increase `key_buffer_size`
  - Increase `max_connections`
  - `slow_query_log` 設定 (but, 使わなかった)
  - Added
    - `disable_log_bin`
    - `wait_timeout`
    - `innodb_buffer_pool_size`
- 実際の設定ファイルは gist に残した
  - <https://gist.github.com/toshimaru/0a9e18d355d839a4d77343216660fbff>

## 所感

- シニアなスーパーエンジニア3人集めたチームがたくさんいる中、ソロ参加のtakonomuraさんが[優勝 & 学生1位](https://isucon.net/archives/58837992.html)取っちゃうのすごすぎる
  - 競技形式だとこういう（良い意味での）化け物がはっきり可視化されるのがいいですね
- 優勝者のリポジトリを見て思ったこと
  - 今回リポジトリには自分が選択した Ruby App だけコミットしたけど、まるっとwebappディレクトリごとコミットしたほうが楽だったかも
  - [秘伝のタレ scripts](https://github.com/takonomura/isucon14/tree/master/scripts) がめっちゃ作り込まれていてすごかった
- Ruby で SSE はいけたチームはあるんか？
  - 早々にSSE実装のトライは諦めた（そしてそれは正解だったと思う）
  - このへんの実装をしやすい Go とかが改めて羨ましく思った
    - Goは処理の非同期化やキャッシュ化のしやすさがあったりと良い

## さいごに

めっちゃ勉強になった。

次回開催もあるようなら、勉強目的で参加したいと思いました。

## 参考リンク

- 当日の資料
  * [当日マニュアル](https://gist.github.com/wtks/0a3268de13856ed6e18c6560023ec436)
  * [ISURIDE アプリケーションマニュアル](https://gist.github.com/wtks/8eadf471daf7cb59942de02273ce7884)
- 問題: [isucon/isucon14](https://github.com/isucon/isucon14)
- [ISUCON14 問題の解説と講評 : ISUCON公式Blog](https://isucon.net/archives/58869617.html)
- 優勝者のリポジトリ: [takonomura/isucon14: ISUCON14 (2024/12/08, 最終スコア 58153, 優勝)](https://github.com/takonomura/isucon14)
  - コミットを解説している記事: [isucon14 の1位の人のやったことを全てみて学ぶ - フラミナル](https://blog.framinal.life/entry/2024/12/08/235842)
- 参考になった記事
  - [ISUCON14感想戦で864,990点取る方法(参考値)](https://zenn.dev/ponyo877/articles/1e29255b9d19bf)
- mysql メモリチューニング記事: [MySQL でメモリ不足が発生したときのパラメータチューニング #mysql5.7 - Qiita](https://qiita.com/kyrieleison/items/9f303dd046e2fb82fea3)
