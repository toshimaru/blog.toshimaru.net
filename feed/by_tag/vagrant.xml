<?xml version="1.0" encoding="utf-8"?><feed xmlns="http://www.w3.org/2005/Atom" ><generator uri="https://jekyllrb.com/" version="4.3.1">Jekyll</generator><link href="https://blog.toshimaru.net/feed/by_tag/vagrant.xml" rel="self" type="application/atom+xml" /><link href="https://blog.toshimaru.net/" rel="alternate" type="text/html" /><updated>2023-01-17T09:45:03+09:00</updated><id>https://blog.toshimaru.net/feed/by_tag/vagrant.xml</id><title type="html">Hack Your Design!</title><subtitle>toshimaruの技術系なブログ</subtitle><author><name>Toshimaru</name></author><entry><title type="html">1円クラウド・DigitalOceanのインスタンスをVagrantで上げて、puppetでプロビジョニングする</title><link href="https://blog.toshimaru.net/digital-ocean-vagrant-puppet/" rel="alternate" type="text/html" title="1円クラウド・DigitalOceanのインスタンスをVagrantで上げて、puppetでプロビジョニングする" /><published>2014-03-12T00:00:00+09:00</published><updated>2014-03-12T00:00:00+09:00</updated><id>https://blog.toshimaru.net/digital-ocean-vagrant-puppet</id><content type="html" xml:base="https://blog.toshimaru.net/digital-ocean-vagrant-puppet/"><![CDATA[<p>流行りの1円クラウド、<a href="https://m.do.co/c/a79091850c6e">DigitalOcean</a>上にVagrantでインスタンス(DigitalOcean的にはDroplet)を立ててみて、それが感動的にラクだったので書き残しておく。</p>

<h2 id="install-vagrant-command">Install vagrant command</h2>

<p>Mac使っているのであれば<a href="https://github.com/phinze/homebrew-cask">homebrew-cask</a>を使うのが便利。</p>

<div class="language-console highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gp">$</span><span class="w"> </span>brew cask <span class="nb">install </span>vagrant
</code></pre></div></div>

<p>バージョンは1.5.1</p>

<div class="language-console highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gp">$</span><span class="w"> </span>vagrant <span class="nt">-v</span>
<span class="go">Vagrant 1.5.1
</span></code></pre></div></div>

<h2 id="install-vagrant-digitalocean-plugin">Install vagrant-digitalocean plugin</h2>

<p>そのままではDigitalOceanは使えないので、次にvagrantのDigitalOceanプラグインをインストール。</p>

<div class="language-console highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gp">$</span><span class="w"> </span>vagrant plugin <span class="nb">install </span>vagrant-digitalocean
</code></pre></div></div>

<h2 id="vagrantfile-configuration">Vagrantfile Configuration</h2>

<p>まずはVagrantfileを用意。</p>

<div class="language-console highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gp">$</span><span class="w"> </span><span class="nb">mkdir </span>vagrant-digitalocean-test
<span class="gp">$</span><span class="w"> </span><span class="nb">cd </span>vagrant-digitalocean-test
<span class="gp">$</span><span class="w"> </span><span class="nb">touch </span>Vagrantfile
</code></pre></div></div>

<p>次に<code class="language-plaintext highlighter-rouge">Vagrantfile</code>に書く設定。</p>

<div class="language-rb highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="no">Vagrant</span><span class="p">.</span><span class="nf">configure</span><span class="p">(</span><span class="s1">'2'</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">config</span><span class="o">|</span>
  <span class="n">config</span><span class="p">.</span><span class="nf">vm</span><span class="p">.</span><span class="nf">provider</span> <span class="ss">:digital_ocean</span> <span class="k">do</span> <span class="o">|</span><span class="n">provider</span><span class="p">,</span> <span class="n">override</span><span class="o">|</span>
    <span class="n">override</span><span class="p">.</span><span class="nf">ssh</span><span class="p">.</span><span class="nf">private_key_path</span> <span class="o">=</span> <span class="s1">'~/.ssh/id_rsa'</span>
    <span class="n">override</span><span class="p">.</span><span class="nf">vm</span><span class="p">.</span><span class="nf">box</span> <span class="o">=</span> <span class="s1">'digital_ocean'</span>
    <span class="n">override</span><span class="p">.</span><span class="nf">vm</span><span class="p">.</span><span class="nf">box_url</span> <span class="o">=</span> <span class="s2">"https://github.com/smdahlen/vagrant-digitalocean/raw/master/box/digital_ocean.box"</span>

    <span class="n">provider</span><span class="p">.</span><span class="nf">client_id</span> <span class="o">=</span> <span class="s1">'{your_client_id}'</span>
    <span class="n">provider</span><span class="p">.</span><span class="nf">api_key</span> <span class="o">=</span> <span class="s1">'{your_api_key}'</span>

    <span class="n">provider</span><span class="p">.</span><span class="nf">image</span>                <span class="o">=</span> <span class="s1">'CentOS 6.4 x64'</span>
    <span class="n">provider</span><span class="p">.</span><span class="nf">region</span>               <span class="o">=</span> <span class="s1">'San Francisco 1'</span>
    <span class="n">provider</span><span class="p">.</span><span class="nf">size</span>                 <span class="o">=</span> <span class="s1">'512MB'</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div></div>

<p><code class="language-plaintext highlighter-rouge">provider.client_id</code>, <code class="language-plaintext highlighter-rouge">provider.api_key</code>の値はアカウント作成後、下記URLより生成できる。</p>

<p><a href="https://cloud.digitalocean.com/api_access">https://cloud.digitalocean.com/api_access</a></p>

<p>今回はCentOS6.4、場所はサンフランシスコ、サイズは512で作ってみる。</p>

<h2 id="インスタンス作成">インスタンス作成！</h2>

<p>あとはこのコマンドのみ。</p>

<div class="language-console highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gp">$</span><span class="w"> </span>vagrant up <span class="nt">--provider</span> digital_ocean
</code></pre></div></div>

<p>これで一分くらい待つと立ち上がりました。動いてます。</p>

<div class="language-console highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gp">$</span><span class="w"> </span>vagrant status
<span class="go">Current machine states:

default                   active (digital_ocean)

active
</span></code></pre></div></div>

<p>あとは<code class="language-plaintext highlighter-rouge">vagrant ssh</code>するなり<code class="language-plaintext highlighter-rouge">vagrant destroy</code>（インスタンス破棄[重要！]）するなり。</p>

<h2 id="プロビジョニング">プロビジョニング</h2>

<p>これだけでは最小パッケージで必要なパッケージが入ってなく片手落ち。そうだ、puppetでプロビジョニングしてみよう。<code class="language-plaintext highlighter-rouge">Vagrantfile</code>をこうしてみる。</p>

<div class="language-rb highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="no">Vagrant</span><span class="p">.</span><span class="nf">configure</span><span class="p">(</span><span class="s1">'2'</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">config</span><span class="o">|</span>
  <span class="n">config</span><span class="p">.</span><span class="nf">vm</span><span class="p">.</span><span class="nf">provision</span> <span class="s2">"shell"</span><span class="p">,</span> <span class="ss">inline: </span><span class="s2">"rpm -Uvh http://ftp-srv2.kddilabs.jp/Linux/distributions/fedora/epel/6/x86_64/epel-release-6-8.noarch.rpm --force"</span>
  <span class="n">config</span><span class="p">.</span><span class="nf">vm</span><span class="p">.</span><span class="nf">provision</span> <span class="s2">"shell"</span><span class="p">,</span> <span class="ss">inline: </span><span class="s2">"yum -y install puppet"</span>

  <span class="n">config</span><span class="p">.</span><span class="nf">vm</span><span class="p">.</span><span class="nf">provider</span> <span class="ss">:digital_ocean</span> <span class="k">do</span> <span class="o">|</span><span class="n">provider</span><span class="p">,</span> <span class="n">override</span><span class="o">|</span>
    <span class="n">override</span><span class="p">.</span><span class="nf">ssh</span><span class="p">.</span><span class="nf">private_key_path</span> <span class="o">=</span> <span class="s1">'~/.ssh/id_rsa'</span>
    <span class="n">override</span><span class="p">.</span><span class="nf">vm</span><span class="p">.</span><span class="nf">box</span> <span class="o">=</span> <span class="s1">'digital_ocean'</span>
    <span class="n">override</span><span class="p">.</span><span class="nf">vm</span><span class="p">.</span><span class="nf">box_url</span> <span class="o">=</span> <span class="s2">"https://github.com/smdahlen/vagrant-digitalocean/raw/master/box/digital_ocean.box"</span>

    <span class="n">provider</span><span class="p">.</span><span class="nf">client_id</span> <span class="o">=</span> <span class="s1">'{client_id}'</span>
    <span class="n">provider</span><span class="p">.</span><span class="nf">api_key</span> <span class="o">=</span> <span class="s1">'{api_key}'</span>

    <span class="n">provider</span><span class="p">.</span><span class="nf">image</span>                <span class="o">=</span> <span class="s1">'CentOS 6.4 x64'</span>
    <span class="n">provider</span><span class="p">.</span><span class="nf">region</span>               <span class="o">=</span> <span class="s1">'San Francisco 1'</span>
    <span class="n">provider</span><span class="p">.</span><span class="nf">size</span>                 <span class="o">=</span> <span class="s1">'512MB'</span>
  <span class="k">end</span>

  <span class="n">config</span><span class="p">.</span><span class="nf">vm</span><span class="p">.</span><span class="nf">provision</span> <span class="s2">"puppet"</span> <span class="k">do</span> <span class="o">|</span><span class="n">puppet</span><span class="o">|</span>
    <span class="n">puppet</span><span class="p">.</span><span class="nf">options</span>                <span class="o">=</span> <span class="s2">"--verbose"</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div></div>

<p>最初にpuppetをインストールコマンドを追加。そして</p>

<h2 id="puppet-manifest">puppet manifest</h2>

<p>puppetのmanifestファイルを定義します。</p>

<div class="language-console highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gp">$</span><span class="w"> </span><span class="nb">mkdir </span>manifests
<span class="gp">$</span><span class="w"> </span><span class="nb">touch </span>manifests/default.pp
</code></pre></div></div>

<p><code class="language-plaintext highlighter-rouge">manifests/default.pp</code>はこう。vimとgitのパッケージを追加。必要に応じて追加したりする。</p>

<div class="language-rb highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">package</span> <span class="p">{</span>
  <span class="p">[</span>
    <span class="s1">'vim-enhanced'</span><span class="p">,</span>
    <span class="s1">'git'</span><span class="p">,</span>
  <span class="p">]:</span>
  <span class="k">ensure</span> <span class="o">=&gt;</span> <span class="n">installed</span>
<span class="p">}</span>
</code></pre></div></div>

<h2 id="lets-provision">Let’s provision!</h2>

<div class="language-console highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gp">$</span><span class="w"> </span>vagrant provision
</code></pre></div></div>

<p>これでpuppet経由で、vimやらgitが入る。良い。</p>

<h2 id="本当に１円">本当に１円？</h2>

<p>はい。１円です。</p>

<p>検証環境として使ったあとに、Dropletをちゃんと破棄していればこうなります。</p>

<p><img src="/images/posts/vagrant/bill.png" alt="bill" /></p>

<p>現時点で<code class="language-plaintext highlighter-rouge">1USD</code> = <code class="language-plaintext highlighter-rouge">102JPY</code>くらいなので<code class="language-plaintext highlighter-rouge">0.01USD</code>=約１円ですね。</p>

<h2 id="github-repository">GitHub Repository</h2>

<p>Githubに今回のサンプルの最終形を置いておく。</p>

<p><a href="https://github.com/toshimaru/vagrant-digitalocean-puppet">https://github.com/toshimaru/vagrant-digitalocean-puppet</a></p>

<h3 id="参考">参考</h3>

<ul>
  <li><a href="https://m.do.co/c/a79091850c6e">Simple Cloud Computing, Built for Developers | DigitalOcean</a></li>
  <li><a href="http://blog.glidenote.com/blog/2013/12/05/digital-ocean-with-vagrant/">VagrantとSSDなVPS(Digital Ocean)で1時間1円の使い捨て高速サーバ環境を構築する</a></li>
</ul>

<hr />

<p>この記事を気に入っていただけたなら下記のリファラルリンクよりDigital Oceanにご登録いただけますと筆者が喜びます(*´ω｀*)</p>

<p><a href="https://m.do.co/c/a79091850c6e"><img src="/images/digitalocean.png" alt="digitalocean" /></a></p>]]></content><author><name>Toshimaru</name></author><category term="digitalocean" /><category term="vagrant" /><summary type="html"><![CDATA[流行りの1円クラウド、DigitalOcean上にVagrantでインスタンス(DigitalOcean的にはDroplet)を立ててみて、それが感動的にラクだったので書き残しておく。]]></summary><media:thumbnail xmlns:media="http://search.yahoo.com/mrss/" url="https://blog.toshimaru.net/images/posts/vagrant/vagrant.png" /><media:content medium="image" url="https://blog.toshimaru.net/images/posts/vagrant/vagrant.png" xmlns:media="http://search.yahoo.com/mrss/" /></entry></feed>