<?xml version="1.0" encoding="utf-8"?><feed xmlns="http://www.w3.org/2005/Atom" ><generator uri="https://jekyllrb.com/" version="4.2.0">Jekyll</generator><link href="https://blog.toshimaru.net/feed/by_tag/opsworks.xml" rel="self" type="application/atom+xml" /><link href="https://blog.toshimaru.net/" rel="alternate" type="text/html" /><updated>2021-03-16T08:57:00+09:00</updated><id>https://blog.toshimaru.net/feed/by_tag/opsworks.xml</id><title type="html">Hack Your Design!</title><subtitle>toshimaruの技術系なブログ</subtitle><author><name>Toshimaru</name></author><entry><title type="html">GunosyでのRails開発フロー</title><link href="https://blog.toshimaru.net/gunosy-rails-way/" rel="alternate" type="text/html" title="GunosyでのRails開発フロー" /><published>2014-12-22T00:00:00+09:00</published><updated>2014-12-22T00:00:00+09:00</updated><id>https://blog.toshimaru.net/gunosy-rails-way</id><content type="html" xml:base="https://blog.toshimaru.net/gunosy-rails-way/">&lt;p&gt;&lt;strong&gt;この当時の内容と大きく変わっていませんが、最新のRails開発について&lt;a href=&quot;http://tech.gunosy.io/entry/gunosy-admin-rails&quot;&gt;公式テックブログ&lt;/a&gt;に書きました。そちらも合わせてご参照ください。&lt;/strong&gt;&lt;/p&gt;

&lt;hr /&gt;

&lt;p&gt;この記事は&lt;a href=&quot;http://qiita.com/advent-calendar/2014/gunosy&quot;&gt;Gunosy Advent Calendar 2014&lt;/a&gt;の22日目の記事です。&lt;/p&gt;

&lt;p&gt;こんにちは、Gunosyの&lt;a href=&quot;https://twitter.com/toshimaru_e&quot;&gt;toshimaru&lt;/a&gt;です。Gunosyでは主にRuby on Railsアプリを担当しています。&lt;/p&gt;

&lt;h2 id=&quot;はじめに&quot;&gt;はじめに&lt;/h2&gt;
&lt;p&gt;Gunosyでは昨年度よりAPIの実装を&lt;a href=&quot;https://speakerdeck.com/ymatsuwitter/300mo-ren-wogodeba-itahua&quot;&gt;Rails実装からGo実装へと変えた&lt;/a&gt;ことでAPIのパフォーマンスの大幅な改善が行われました。そんなわけで「GunosyってRails捨ててGoを使ってるんじゃないの？」とお思いの方もいらっしゃるかもしれませんがそんなことはありません。大規模アクセスのない管理画面などではRuby on RailsはまだまだGunosyで現役バリバリです&lt;sup id=&quot;fnref:2&quot; role=&quot;doc-noteref&quot;&gt;&lt;a href=&quot;#fn:2&quot; class=&quot;footnote&quot;&gt;1&lt;/a&gt;&lt;/sup&gt;。高速にWEBアプリを作る必要のあるシーンにおいてはGoはRailsにはまだ敵いません。あのGoカンパニーとして名高いHashiCorpでさえも&lt;a href=&quot;http://blog.gopheracademy.com/advent-2014/atlas/&quot;&gt;Railsは手放せない&lt;/a&gt;ようですしね。&lt;/p&gt;

&lt;p&gt;本エントリでは僕がGunosyでかかわっているRailsプロジェクトにおいてどのように開発を進めていっているのかを紹介したいと思います&lt;sup id=&quot;fnref:1&quot; role=&quot;doc-noteref&quot;&gt;&lt;a href=&quot;#fn:1&quot; class=&quot;footnote&quot;&gt;2&lt;/a&gt;&lt;/sup&gt;。&lt;/p&gt;

&lt;h2 id=&quot;ブランチの運用&quot;&gt;ブランチの運用&lt;/h2&gt;
&lt;p&gt;基本は&lt;a href=&quot;http://danielkummer.github.io/git-flow-cheatsheet/index.ja_JP.html&quot;&gt;Git flow&lt;/a&gt;に則って開発を進めています。ただGit flowにおけるリリースブランチの運用はフローの簡易化のため、またスモールチーム（２〜３人）での開発ということもあり省いています。これによりdevelop→master間のフローがラクになりスピーディな開発が可能になります。&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;/images/posts/gunosy/deploy.png&quot; alt=&quot;&quot; /&gt;&lt;/p&gt;

&lt;p&gt;&lt;strong&gt;【↑図】developからfeatureブランチが切られ、developにマージ・確認した後にmasterへ&lt;/strong&gt;&lt;/p&gt;

&lt;h2 id=&quot;デプロイ&quot;&gt;デプロイ&lt;/h2&gt;
&lt;p&gt;デプロイフローは下記のようになっています。&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;/images/posts/gunosy/workflow.png&quot; alt=&quot;&quot; /&gt;&lt;/p&gt;

&lt;ol&gt;
  &lt;li&gt;ローカルで開発&lt;/li&gt;
  &lt;li&gt;コードをGithubにプッシュ&lt;/li&gt;
  &lt;li&gt;CircleCIでテスト &amp;amp; テスト結果を通知&lt;/li&gt;
  &lt;li&gt;CircleCIからAmazon OpsWorksにデプロイ命令（Chefのデプロイレシピを実行させる）&lt;/li&gt;
  &lt;li&gt;OpsWorksからデプロイ完了通知&lt;/li&gt;
&lt;/ol&gt;

&lt;p&gt;※Amazon OpsWorksについては昨日のChefAdventCalendarにまとめさせていただきましたのでよかったらどうぞ。&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;/opsworks-rails/&quot;&gt;Amazon OpsWorksでRailsアプリを簡単Chefプロビジョニング&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;上記のブランチ運用と照らし合わせるとこうなります。&lt;/p&gt;

&lt;table&gt;
  &lt;tbody&gt;
    &lt;tr&gt;
      &lt;td&gt;&lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;develop&lt;/code&gt;ブランチ変更時&lt;/td&gt;
      &lt;td&gt;CircleCIテスト後に、（テストパスすれば）OpsWorksのステージング環境に&lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;develop&lt;/code&gt; ブランチをデプロイ&lt;/td&gt;
    &lt;/tr&gt;
    &lt;tr&gt;
      &lt;td&gt;&lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;master&lt;/code&gt;ブランチ変更時&lt;/td&gt;
      &lt;td&gt;CircleCIテスト後に、OpsWorksのプロダクション環境に&lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;master&lt;/code&gt;ブランチをデプロイ&lt;/td&gt;
    &lt;/tr&gt;
  &lt;/tbody&gt;
&lt;/table&gt;

&lt;p&gt;アプリケーションレポジトリの責任範囲がCircleCIでテストを実行してOpsWorksにデプロイリクエストを投げるまでで、その後のデプロイは別レポジトリとして管理されているChefのレシピの責任範囲として役割が分けられています。デプロイ環境が一通り揃ってしまえば、アプリケーション開発者はほとんどデプロイに関するアレコレを考える必要がなく本来の開発に集中できます。&lt;/p&gt;

&lt;h2 id=&quot;railsのバージョン&quot;&gt;Railsのバージョン&lt;/h2&gt;
&lt;p&gt;入社以来、Gunosyでは２つのRailsプロジェクトにかかわってきましたが（どちらも入社後にゼロから開始したプロジェクトです）両プロジェクトともにバージョン4.1.8です。まだ現時点で最新のバージョン4.2.0には上げてませんが今後も最新のRailsに追従していく所存です。&lt;/p&gt;

&lt;h2 id=&quot;テスト&quot;&gt;テスト&lt;/h2&gt;
&lt;p&gt;Railsのテストに関してはRSpec, FactoryGirl, Capybaraあたりを使っています。&lt;/p&gt;

&lt;table&gt;
  &lt;tbody&gt;
    &lt;tr&gt;
      &lt;td&gt;RSpec&lt;/td&gt;
      &lt;td&gt;モデル、コントローラー周りのテスト&lt;/td&gt;
    &lt;/tr&gt;
    &lt;tr&gt;
      &lt;td&gt;Capybara&lt;/td&gt;
      &lt;td&gt;ビューを含むEnd-to-Endテスト&lt;sup id=&quot;fnref:3&quot; role=&quot;doc-noteref&quot;&gt;&lt;a href=&quot;#fn:3&quot; class=&quot;footnote&quot;&gt;3&lt;/a&gt;&lt;/sup&gt;&lt;/td&gt;
    &lt;/tr&gt;
  &lt;/tbody&gt;
&lt;/table&gt;

&lt;p&gt;カバレッジ率に関しては90%前後を保っています。カバレッジは&lt;a href=&quot;https://github.com/colszowka/simplecov&quot;&gt;simplecov&lt;/a&gt;を使用し、結果作成されるカバレッジ率はCircleCIの&lt;a href=&quot;https://circleci.com/docs/build-artifacts&quot;&gt;artifacts&lt;/a&gt;の機能を使いカバレッジ率と共に公開しています。&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;/images/posts/gunosy/coverage.png&quot; alt=&quot;&quot; /&gt;&lt;/p&gt;

&lt;p&gt;&lt;strong&gt;【↑図】artifactsで公開されたカバレッジ率&lt;/strong&gt;&lt;/p&gt;

&lt;p&gt;ただ「テストカバレッジを上げること」が目的化してしまっては本末転倒なので（いわゆる「テスト書きすぎ問題」）、「どこまでテストを書くか」は今後も考えていきたいテーマではあります。&lt;/p&gt;

&lt;h2 id=&quot;複数db&quot;&gt;複数DB&lt;/h2&gt;
&lt;p&gt;Railsの悩みとして１つ大きいのは複数DBの扱いではないでしょうか？ Gunosyでももちろん複数DBを使い分ける必要があり、そのときはCookpadさん, DeNAさんで実績のある&lt;a href=&quot;https://github.com/eagletmt/switch_point&quot;&gt;swith_point&lt;/a&gt; gemを使用しています。&lt;/p&gt;

&lt;p&gt;この2社のDB事情に関しては下記ブログ・資料に詳しいです。&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;&lt;a href=&quot;http://techlife.cookpad.com/entry/2014/08/28/194147&quot;&gt;クックパッドにおける最近のActiveRecord運用事情&lt;/a&gt;&lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;http://www.slideshare.net/sonots/mobage-ruby-db&quot;&gt;Mobage を支える Ruby の技術 ~ 複数DB編 ~&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;上記に紹介されているように下記のように簡単に複数DBをswitchでき素敵です。&lt;/p&gt;

&lt;figure class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-ruby&quot; data-lang=&quot;ruby&quot;&gt;&lt;span class=&quot;c1&quot;&gt;# Configuration&lt;/span&gt;
&lt;span class=&quot;no&quot;&gt;SwitchPoint&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;configure&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;do&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;|&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;config&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;|&lt;/span&gt;
  &lt;span class=&quot;n&quot;&gt;config&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;define_switch_point&lt;/span&gt; &lt;span class=&quot;ss&quot;&gt;:blog&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
    &lt;span class=&quot;ss&quot;&gt;readonly: :&quot;&lt;/span&gt;&lt;span class=&quot;si&quot;&gt;#{&lt;/span&gt;&lt;span class=&quot;no&quot;&gt;Rails&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;env&lt;/span&gt;&lt;span class=&quot;si&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;ss&quot;&gt;_blog_slave&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
    &lt;span class=&quot;ss&quot;&gt;writable: :&quot;&lt;/span&gt;&lt;span class=&quot;si&quot;&gt;#{&lt;/span&gt;&lt;span class=&quot;no&quot;&gt;Rails&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;env&lt;/span&gt;&lt;span class=&quot;si&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;ss&quot;&gt;_blog_master&quot;&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;end&lt;/span&gt;

&lt;span class=&quot;c1&quot;&gt;# Model&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;class&lt;/span&gt; &lt;span class=&quot;nc&quot;&gt;Article&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;lt;&lt;/span&gt; &lt;span class=&quot;no&quot;&gt;ActiveRecord&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;::&lt;/span&gt;&lt;span class=&quot;no&quot;&gt;Base&lt;/span&gt;
  &lt;span class=&quot;n&quot;&gt;use_switch_point&lt;/span&gt; &lt;span class=&quot;ss&quot;&gt;:blog&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;end&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/figure&gt;

&lt;p&gt;Railsの機能として複数データベースがサポートされる話もあるようなのでそこも期待ですね。&lt;a href=&quot;http://mozaic.fm/post/104575088493/12-rails&quot;&gt;参考: #12 Rails mozaic.fm&lt;/a&gt;&lt;/p&gt;

&lt;h2 id=&quot;権限管理&quot;&gt;権限管理&lt;/h2&gt;
&lt;p&gt;管理画面の権限管理に関しては&lt;a href=&quot;https://github.com/nathanl/authority&quot;&gt;authority&lt;/a&gt;を使用しています。権限は大まかにそれぞれの機能においてそれを参照できる権限（READ）・更新できる権限（CREATE/UPDATE/DELETE）というような権限分けを行っています。例えば＜ユーザーを閲覧可能＞という権限、＜ユーザーを更新可能＞な権限、これらを組み合わせて管理ユーザーの権限を定義します。&lt;/p&gt;

&lt;p&gt;なお、初期の権限設定は&lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;seeds.rb&lt;/code&gt;で権限をまくようにしています。&lt;/p&gt;

&lt;h2 id=&quot;バッチ&quot;&gt;バッチ&lt;/h2&gt;
&lt;p&gt;cronの管理に関しては&lt;a href=&quot;https://github.com/javan/whenever&quot;&gt;whenever&lt;/a&gt;を使用しています。こちらはOpsWorkのデプロイ実行時にChefのwheneverレシビが定義してあり、そこでcronがデプロイ時に更新されるようになっています。&lt;/p&gt;

&lt;h2 id=&quot;非同期ジョブ&quot;&gt;非同期ジョブ&lt;/h2&gt;
&lt;p&gt;重い処理に関してはSidekiqを使いRails側ではSidekiqにキューイングするまでにして、その後の処理はSidekiqで行うようにしてます。例えばGunosyの場合何が重い処理にあたるかというと「全ユーザーにプッシュ通知を送るぞ！」みたいなケース。そのような時間のかかる処理に関してはSidekiqで処理を行っています&lt;sup id=&quot;fnref:4&quot; role=&quot;doc-noteref&quot;&gt;&lt;a href=&quot;#fn:4&quot; class=&quot;footnote&quot;&gt;4&lt;/a&gt;&lt;/sup&gt;。&lt;/p&gt;

&lt;h2 id=&quot;その他今後の課題&quot;&gt;その他・今後の課題&lt;/h2&gt;
&lt;ul&gt;
  &lt;li&gt;僕が携わったプロジェクトはどちらもRails4系だが、歴史が積み重なったRails3系プロジェクトもあるので今後どうアップデートしていくか。&lt;/li&gt;
  &lt;li&gt;Hubotは遊びで飼ってるけど&lt;a href=&quot;https://speakerdeck.com/jnewland/chatops-at-github&quot;&gt;ChatOps&lt;/a&gt;といえるほど真面目に運用していない。もっとうまく使えば幸せになれるかも？&lt;/li&gt;
&lt;/ul&gt;

&lt;h2 id=&quot;最後に&quot;&gt;最後に&lt;/h2&gt;
&lt;p&gt;Ruby/Rails業務経験歴半年足らずのヒヨッコではありますが、僕がかかわった範囲内でのGunosyでのRailsの開発の方法を紹介してみました。もし「うちはこんなRailsの開発してるよ！」とか「これ使うともっと便利になるよ！」とか教えていただけたら嬉しいです。&lt;/p&gt;

&lt;p&gt;ではでは。&lt;/p&gt;

&lt;div class=&quot;footnotes&quot; role=&quot;doc-endnotes&quot;&gt;
  &lt;ol&gt;
    &lt;li id=&quot;fn:2&quot; role=&quot;doc-endnote&quot;&gt;
      &lt;p&gt;ちなみにDjangoも使われています。 &lt;a href=&quot;#fnref:2&quot; class=&quot;reversefootnote&quot; role=&quot;doc-backlink&quot;&gt;&amp;#8617;&lt;/a&gt;&lt;/p&gt;
    &lt;/li&gt;
    &lt;li id=&quot;fn:1&quot; role=&quot;doc-endnote&quot;&gt;
      &lt;p&gt;とはいえ会社全てのRailsプロダクトが今回紹介するようなやり方で統一されているわけではありません。あくまでも自分がかかわっている範囲での開発の進め方です。 &lt;a href=&quot;#fnref:1&quot; class=&quot;reversefootnote&quot; role=&quot;doc-backlink&quot;&gt;&amp;#8617;&lt;/a&gt;&lt;/p&gt;
    &lt;/li&gt;
    &lt;li id=&quot;fn:3&quot; role=&quot;doc-endnote&quot;&gt;
      &lt;p&gt;デフォルトのrack_testドライバーを使っていますが、&lt;a href=&quot;http://qiita.com/take/items/779747e0981355e569ad&quot;&gt;poltergaistが良さ気なので&lt;/a&gt;今後使っていきたいと思っています。 &lt;a href=&quot;#fnref:3&quot; class=&quot;reversefootnote&quot; role=&quot;doc-backlink&quot;&gt;&amp;#8617;&lt;/a&gt;&lt;/p&gt;
    &lt;/li&gt;
    &lt;li id=&quot;fn:4&quot; role=&quot;doc-endnote&quot;&gt;
      &lt;p&gt;正確には別途配信ワーカーがいるのですがここでは割愛 &lt;a href=&quot;#fnref:4&quot; class=&quot;reversefootnote&quot; role=&quot;doc-backlink&quot;&gt;&amp;#8617;&lt;/a&gt;&lt;/p&gt;
    &lt;/li&gt;
  &lt;/ol&gt;
&lt;/div&gt;</content><author><name>Toshimaru</name></author><category term="rails" /><category term="opsworks" /><summary type="html">この当時の内容と大きく変わっていませんが、最新のRails開発について公式テックブログに書きました。そちらも合わせてご参照ください。</summary></entry><entry><title type="html">Amazon OpsWorksでRailsアプリを簡単Chefプロビジョニング</title><link href="https://blog.toshimaru.net/opsworks-rails/" rel="alternate" type="text/html" title="Amazon OpsWorksでRailsアプリを簡単Chefプロビジョニング" /><published>2014-12-21T00:00:00+09:00</published><updated>2014-12-21T00:00:00+09:00</updated><id>https://blog.toshimaru.net/opsworks-rails</id><content type="html" xml:base="https://blog.toshimaru.net/opsworks-rails/">&lt;p&gt;本記事は&lt;a href=&quot;http://qiita.com/advent-calendar/2014/chef&quot;&gt;Chef Advent Calendar 2014&lt;/a&gt;の21日目の記事です。&lt;/p&gt;

&lt;h2 id=&quot;opsworksとは&quot;&gt;OpsWorksとは？&lt;/h2&gt;
&lt;p&gt;公式サイトの説明は下記です。&lt;/p&gt;

&lt;blockquote&gt;
  &lt;p&gt;設定管理サービスである AWS OpsWorks を使用すると、ユーザーは Chef を使用して、あらゆる種類およびサイズのアプリケーションを簡単に設定および運用できます。パッケージのインストール、ソフトウェア設定およびストレージなどのリソースを含む、各コンポーネントのアプリケーションのアーキテクチャおよび仕様を定義できます。&lt;/p&gt;

  &lt;p&gt;&lt;a href=&quot;http://aws.amazon.com/jp/opsworks/&quot;&gt;AWS OpsWorks&lt;/a&gt;&lt;/p&gt;
&lt;/blockquote&gt;

&lt;p&gt;ポイントは以下の通り。&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;Chefでサーバーをプロビジョニング・デプロイできる&lt;/li&gt;
  &lt;li&gt;スタック ＞ レイヤー ＞ App という概念でシステムを構成&lt;/li&gt;
  &lt;li&gt;インスタンスをタイムベース or ロードベースでスケールアウトできる&lt;/li&gt;
  &lt;li&gt;OpsWorksで使われているレシピは&lt;a href=&quot;https://github.com/aws/opsworks-cookbooks&quot;&gt;Githubで公開&lt;/a&gt;されており実行コードが追える&lt;/li&gt;
  &lt;li&gt;OpsWorksの用意したレシピに加えて自らのCustom Chefレシピを追加することも可能&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;&lt;img src=&quot;/images/posts/opsworks/stack.png&quot; alt=&quot;stack image&quot; /&gt;&lt;/p&gt;

&lt;p&gt;&lt;strong&gt;【↑図】OpsWorksのStack &amp;amp; Layerの関係&lt;/strong&gt;&lt;/p&gt;

&lt;h2 id=&quot;料金&quot;&gt;料金&lt;/h2&gt;
&lt;p&gt;OpsWorksの使用自体にかかる料金は &lt;strong&gt;0円&lt;/strong&gt; です。OpsWorks上で使用したAWSリソースの料金（ロードバランサ、EC2インスタンス、RDS等）のみがかかってきます。&lt;/p&gt;

&lt;h2 id=&quot;railsをopsworksにデプロイしてみよう&quot;&gt;RailsをOpsWorksにデプロイしてみよう&lt;/h2&gt;
&lt;p&gt;OpsWorksはとくにRailsアプリケーションとの相性が良く、今回はRails4.2のアプリケーションをOpsWorksにデプロイしてみようと思います。&lt;/p&gt;

&lt;p&gt;今回デプロイするRailsアプリケーションのコードの最終形は下記になります。&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://github.com/toshimaru/opsworks-rails&quot;&gt;https://github.com/toshimaru/opsworks-rails&lt;/a&gt;&lt;/p&gt;

&lt;h2 id=&quot;デプロイ手順&quot;&gt;デプロイ手順&lt;/h2&gt;

&lt;h3 id=&quot;スタックの追加&quot;&gt;スタックの追加&lt;/h3&gt;

&lt;p&gt;まずはAWS ConsoleからOpsWorksにいきAdd Stackしましょう。RegionとかVPCとかIAMとかは適宜設定してね。&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;/images/posts/opsworks/add_stack.png&quot; alt=&quot;add stack&quot; /&gt;&lt;/p&gt;

&lt;p&gt;こんなのがStackのトップ画面。&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;/images/posts/opsworks/top.png&quot; alt=&quot;stack top&quot; /&gt;&lt;/p&gt;

&lt;h3 id=&quot;レイヤーの定義&quot;&gt;レイヤーの定義&lt;/h3&gt;

&lt;p&gt;&lt;img src=&quot;/images/posts/opsworks/layer.png&quot; alt=&quot;layer&quot; /&gt;&lt;/p&gt;

&lt;p&gt;Layer TypeはRails App、Ruby versionは2.1、nginx+unicornを選択する&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;/images/posts/opsworks/add_layer.png&quot; alt=&quot;add layer&quot; /&gt;&lt;/p&gt;

&lt;p&gt;追加されました。&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;/images/posts/opsworks/layer_done.png&quot; alt=&quot;layer done&quot; /&gt;&lt;/p&gt;

&lt;h3 id=&quot;レシピ&quot;&gt;レシピ&lt;/h3&gt;

&lt;p&gt;RecipesでOpsWorksにどんなレシピが設定されているかがわかります。レシピ名がGithubへのリンクになっており、どんなレシピが書かれているかを確認できます。&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;/images/posts/opsworks/recipes.png&quot; alt=&quot;recipes&quot; /&gt;&lt;/p&gt;

&lt;p&gt;今回はこのままでOK.&lt;/p&gt;

&lt;h3 id=&quot;インスタンスの追加&quot;&gt;インスタンスの追加&lt;/h3&gt;

&lt;p&gt;では次にAppインスタンスを追加。t1.microインスタンスで。&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;/images/posts/opsworks/add_instance.png&quot; alt=&quot;add instance&quot; /&gt;&lt;/p&gt;

&lt;p&gt;AddInstanceするとステータスがStoppedなのでstartで起動します。&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;/images/posts/opsworks/instance_stopped.png&quot; alt=&quot;instance stop&quot; /&gt;&lt;/p&gt;

&lt;p&gt;10分くらいでセットアップが完了します。Statusがonlineでグリーンになれば準備OK.&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;/images/posts/opsworks/instance_online.png&quot; alt=&quot;online&quot; /&gt;&lt;/p&gt;

&lt;h3 id=&quot;appの設定&quot;&gt;Appの設定&lt;/h3&gt;

&lt;p&gt;次にデプロイするAppの設定を追加していきます。&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;/images/posts/opsworks/apps.png&quot; alt=&quot;setting app&quot; /&gt;&lt;/p&gt;

&lt;p&gt;こんな感じでAppを設定。&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;Type: Ruby on Rails&lt;/li&gt;
  &lt;li&gt;DataSource: 今回は特にないのでNone&lt;/li&gt;
  &lt;li&gt;Applicationソース: GithubからデプロイしたいGithubのレポジトリURLを指定&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;&lt;img src=&quot;/images/posts/opsworks/add_apps.png&quot; alt=&quot;add app&quot; /&gt;&lt;/p&gt;

&lt;p&gt;&lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;SECRET_KEY_BASE&lt;/code&gt;(Rails4.2の&lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;secrets.yml&lt;/code&gt;で必要になる)もあわせてセットしましょう。&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;/images/posts/opsworks/add_envvar.png&quot; alt=&quot;env var&quot; /&gt;&lt;/p&gt;

&lt;p&gt;Deployments で Deploy Appしてみよう。&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;/images/posts/opsworks/deploy_app.png&quot; alt=&quot;deploy app&quot; /&gt;&lt;/p&gt;

&lt;p&gt;Appは先ほど設定したApp、CommandはDeployを指定してDeploy App!（マイグレーションが必要であればここでMigration ON）&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;/images/posts/opsworks/deploy_app2.png&quot; alt=&quot;deploy app 2&quot; /&gt;&lt;/p&gt;

&lt;p&gt;SuccessすればOK.&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;/images/posts/opsworks/deploy_app3.png&quot; alt=&quot;deploy finished&quot; /&gt;&lt;/p&gt;

&lt;h2 id=&quot;幾つかのハマりポイント&quot;&gt;幾つかのハマりポイント&lt;/h2&gt;

&lt;h3 id=&quot;gemfile&quot;&gt;Gemfile&lt;/h3&gt;

&lt;p&gt;下記のGemが必要になるのでコメントアウトされていることを確認すること。&lt;/p&gt;

&lt;div class=&quot;language-plaintext highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;gem &apos;therubyracer&apos;, platforms: :ruby
gem &apos;unicorn&apos;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;h3 id=&quot;databaseyml&quot;&gt;database.yml&lt;/h3&gt;

&lt;p&gt;RDSを設定していれば自動的に設定されるのですが、今回の場合設定していないので別途手で&lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;database.yml&lt;/code&gt;を作りました。&lt;/p&gt;

&lt;div class=&quot;language-plaintext highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;[root@rails-app1 current]# cat config/database.yml
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;div class=&quot;language-yml highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;na&quot;&gt;default&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;nl&quot;&gt;&amp;amp;default&lt;/span&gt;
  &lt;span class=&quot;na&quot;&gt;adapter&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;sqlite3&lt;/span&gt;
  &lt;span class=&quot;na&quot;&gt;pool&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;5&lt;/span&gt;
  &lt;span class=&quot;na&quot;&gt;timeout&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;5000&lt;/span&gt;

&lt;span class=&quot;na&quot;&gt;production&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt;
  &lt;span class=&quot;s&quot;&gt;&amp;lt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;*default&lt;/span&gt;
  &lt;span class=&quot;na&quot;&gt;database&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;db/production.sqlite3&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;h3 id=&quot;cssが適応されていない問題&quot;&gt;CSSが適応されていない問題&lt;/h3&gt;

&lt;p&gt;「アレ、なんかCSSが効いていないっぽい！？」&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;/images/posts/opsworks/before_css.png&quot; alt=&quot;css&quot; /&gt;&lt;/p&gt;

&lt;p&gt;これは&lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;asset:precompile&lt;/code&gt;が走っていないため。&lt;/p&gt;

&lt;blockquote&gt;
  &lt;p&gt;rake asset:precompile というタスクを実行する必要がありますが、OpsWorksのRailsアプリケーションのデフォルトのデプロイ処理ではこのタスクを実行してくれません。&lt;/p&gt;

  &lt;p&gt;&lt;a href=&quot;http://interu.hatenablog.com/entry/2013/08/01/214258&quot;&gt;OpsWorksでRailsをデプロイする際にasset:precompileを実施する方法&lt;/a&gt;&lt;/p&gt;
&lt;/blockquote&gt;

&lt;p&gt;下記を&lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;deploy/before_migrate.rb&lt;/code&gt;に設定する。&lt;/p&gt;

&lt;div class=&quot;language-rb highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;no&quot;&gt;Chef&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;::&lt;/span&gt;&lt;span class=&quot;no&quot;&gt;Log&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;info&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;Running deploy/before_migrate.rb&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;span class=&quot;n&quot;&gt;env&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;node&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;ss&quot;&gt;:deploy&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;][&lt;/span&gt;&lt;span class=&quot;ss&quot;&gt;:rails_opsworks&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;][&lt;/span&gt;&lt;span class=&quot;ss&quot;&gt;:rails_env&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]&lt;/span&gt;
&lt;span class=&quot;n&quot;&gt;current_release&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;release_path&lt;/span&gt;

&lt;span class=&quot;n&quot;&gt;execute&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;rake assets:precompile&quot;&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;do&lt;/span&gt;
  &lt;span class=&quot;n&quot;&gt;cwd&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;current_release&lt;/span&gt;
  &lt;span class=&quot;n&quot;&gt;command&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;bundle exec rake assets:precompile&quot;&lt;/span&gt;
  &lt;span class=&quot;n&quot;&gt;environment&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;RAILS_ENV&quot;&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&amp;gt;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;env&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;end&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;これでデプロイ。&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;/images/posts/opsworks/after_css.png&quot; alt=&quot;css 2&quot; /&gt;&lt;/p&gt;

&lt;p&gt;OK.&lt;/p&gt;

&lt;h3 id=&quot;デプロイディレクトリ&quot;&gt;デプロイ・ディレクトリ&lt;/h3&gt;

&lt;p&gt;&lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;/srv/www/rails_opsworks/current&lt;/code&gt;に最新の状態がデプロイされます。&lt;/p&gt;

&lt;h3 id=&quot;ログディレクトリ&quot;&gt;ログ・ディレクトリ&lt;/h3&gt;

&lt;p&gt;&lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;/var/lib/aws/opsworks/chef&lt;/code&gt; Chefのログ、OpsWorksの設定JSONが格納されています。&lt;/p&gt;

&lt;h2 id=&quot;まとめ&quot;&gt;まとめ&lt;/h2&gt;

&lt;p&gt;さてOpsWorksでのデプロイ手順を紹介してきましたが一体何が嬉しいのでしょうか。個人的なメリットは以下です。&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;インスタンスが Disposable（廃棄可能）・Reproducible（再現可能） である
    &lt;ul&gt;
      &lt;li&gt;いわゆる immutable infrastructure&lt;/li&gt;
      &lt;li&gt;= サーバーをいつでも潰して全く同じ環境を再現できる！&lt;/li&gt;
      &lt;li&gt;「サーバーを増やしたい！」 → Add Instanceをポチるだけ&lt;/li&gt;
    &lt;/ul&gt;
  &lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;https://github.com/capistrano/capistrano&quot;&gt;Capistrano&lt;/a&gt;などのデプロイツールのコードをゴチャゴチャ書く必要がなく、デプロイタスクはOpsWorks &amp;amp; Chefに一任できる&lt;/li&gt;
&lt;/ul&gt;

&lt;h2 id=&quot;さいごに&quot;&gt;さいごに&lt;/h2&gt;

&lt;p&gt;Chef Advent CalendarといいながらChefよりもOpsWorks中心の内容になってしまいましたが、冒頭に書いたようにOpsWorksの用意しているレシピに加えて自らのCustom Chefレシピを定義することが可能です。現実的な運用を考えるとOpsWorksのレシピだけでプロビジョニング・デプロイレシピを完結させることは難しいと思うので、&lt;strong&gt;OpsWorksレシピ+Custom Chefレシピ&lt;/strong&gt; の２つを組み合わせて運用していくのが現実的かと思います。&lt;/p&gt;

&lt;h2 id=&quot;link-参考&quot;&gt;:link: 参考&lt;/h2&gt;

&lt;ul&gt;
  &lt;li&gt;&lt;a href=&quot;http://ruby.awsblog.com/post/Tx7FQMT084INCR/Deploying-Ruby-on-Rails-Applications-to-AWS-OpsWorks&quot;&gt;Deploying Ruby on Rails Applications to AWS OpsWorks&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;</content><author><name>Toshimaru</name></author><category term="chef" /><category term="opsworks" /><category term="rails" /><category term="aws" /><summary type="html">本記事はChef Advent Calendar 2014の21日目の記事です。</summary><media:thumbnail xmlns:media="http://search.yahoo.com/mrss/" url="https://blog.toshimaru.net/images/posts/opsworks/eyecatch.png" /><media:content medium="image" url="https://blog.toshimaru.net/images/posts/opsworks/eyecatch.png" xmlns:media="http://search.yahoo.com/mrss/" /></entry></feed>