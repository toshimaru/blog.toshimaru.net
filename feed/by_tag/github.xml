<?xml version="1.0" encoding="utf-8"?><feed xmlns="http://www.w3.org/2005/Atom" ><generator uri="https://jekyllrb.com/" version="4.2.2">Jekyll</generator><link href="https://blog.toshimaru.net/feed/by_tag/github.xml" rel="self" type="application/atom+xml" /><link href="https://blog.toshimaru.net/" rel="alternate" type="text/html" /><updated>2022-04-16T16:21:15+09:00</updated><id>https://blog.toshimaru.net/feed/by_tag/github.xml</id><title type="html">Hack Your Design!</title><subtitle>toshimaruの技術系なブログ</subtitle><author><name>Toshimaru</name></author><entry><title type="html">PR作者を自動でアサインするGitHub Actions, auto-author-assign を作った</title><link href="https://blog.toshimaru.net/auto-author-assign/" rel="alternate" type="text/html" title="PR作者を自動でアサインするGitHub Actions, auto-author-assign を作った" /><published>2020-12-06T00:00:00+09:00</published><updated>2020-12-06T00:00:00+09:00</updated><id>https://blog.toshimaru.net/auto-author-assign</id><content type="html" xml:base="https://blog.toshimaru.net/auto-author-assign/"><![CDATA[<p>本記事は<a href="https://qiita.com/advent-calendar/2020/github-actions">GitHub Actions Advent Calendar 2020</a>６日目の記事です。</p>

<p>今日は作ったGitHub Actions、<a href="https://github.com/toshimaru/auto-author-assign">auto-author-assign</a>の紹介をしたいと思います。</p>

<h2 id="作ったきっかけ">作ったきっかけ</h2>

<p>Pull Request（以下、PRと表記）を作成をしたとき、多くの場合そのPRの担当者（<code class="language-plaintext highlighter-rouge">Assignee</code>）はそのPR作者自身になるかと思います。</p>

<p>その「PR担当者をPR作者にアサインする」アクションを自動化した、というのが今回作成したGitHub Actionsになります。</p>

<h2 id="何が嬉しいか">何が嬉しいか？</h2>

<p>たくさんの人がPRを出しまくる、そんな大規模プロジェクトだとPR一覧を開いたときに</p>

<ul>
  <li>「誰がPRの担当者なのか？」がアイコンで一目でわかるようになる</li>
  <li>（<code class="language-plaintext highlighter-rouge">Author</code> に加えて）<code class="language-plaintext highlighter-rouge">Assignee</code> によるフィルターができるようになる</li>
</ul>

<p>あたりが嬉しさになります。</p>

<p><img src="/images/posts/auto-author-assign/pull-request-list.png" alt="PR list" /></p>

<h2 id="設定">設定</h2>

<p>リポジトリに <code class="language-plaintext highlighter-rouge">.github/workflows/auto-author-assign.yml</code> みたいなファイルを用意して下記のように設定すればOK。</p>

<div class="language-yml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">name</span><span class="pi">:</span> <span class="s1">'</span><span class="s">Auto</span><span class="nv"> </span><span class="s">Author</span><span class="nv"> </span><span class="s">Assign'</span>

<span class="na">on</span><span class="pi">:</span>
  <span class="na">pull_request_target</span><span class="pi">:</span>
    <span class="na">types</span><span class="pi">:</span> <span class="pi">[</span><span class="nv">opened</span><span class="pi">,</span> <span class="nv">reopened</span><span class="pi">]</span>

<span class="na">jobs</span><span class="pi">:</span>
  <span class="na">assign-author</span><span class="pi">:</span>
    <span class="na">runs-on</span><span class="pi">:</span> <span class="s">ubuntu-latest</span>
    <span class="na">steps</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="na">uses</span><span class="pi">:</span> <span class="s">toshimaru/auto-author-assign@v1.2.0</span>
        <span class="na">with</span><span class="pi">:</span>
          <span class="na">repo-token</span><span class="pi">:</span> <span class="s2">"</span><span class="s">$"</span>
</code></pre></div></div>

<h3 id="on-pull_request-ではアサイン失敗することがある">on: pull_request ではアサイン失敗することがある</h3>

<p>最初、 <code class="language-plaintext highlighter-rouge">on: pull_request</code> でイベント発火させていたのですが、これだとfolkしたレポジトリからのPRで下記エラーが出てアサインが失敗します。</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Error: Resource not accessible by integration
</code></pre></div></div>

<p>なぜなら folk したレポジトリからは <code class="language-plaintext highlighter-rouge">secrets.GITHUB_TOKEN</code> にアクセスできないためです。</p>

<blockquote>
  <p>This event is similar to pull_request, except that it runs in the context of the base repository of the pull request (snip) This means that you can more safely make your secrets available to the workflows triggered by the pull request</p>
</blockquote>

<p>via. <a href="https://docs.github.com/en/free-pro-team@latest/actions/reference/events-that-trigger-workflows#pull_request_target">Events that trigger workflows - GitHub Docs</a></p>

<p>ということで、 <code class="language-plaintext highlighter-rouge">on: pull_request_target</code> 使ってActionを起動させる必要があります。</p>

<h2 id="余談">余談</h2>

<p>本Actionは<a href="https://dev.to/devteam/announcing-the-github-actions-hackathon-on-dev-3ljn">GitHub Actions Hackathon</a>にも提出しました<sup id="fnref:1" role="doc-noteref"><a href="#fn:1" class="footnote" rel="footnote">1</a></sup>。</p>

<div class="footnotes" role="doc-endnotes">
  <ol>
    <li id="fn:1" role="doc-endnote">
      <p><a href="https://dev.to/toshimaru/assign-pull-request-author-automatically-with-github-actions-2i9o">Assign pull request author automatically with GitHub Actions - DEV Community 👩‍💻👨‍💻</a> <a href="#fnref:1" class="reversefootnote" role="doc-backlink">&#8617;</a></p>
    </li>
  </ol>
</div>]]></content><author><name>Toshimaru</name></author><category term="github_actions" /><category term="ci" /><category term="github" /><summary type="html"><![CDATA[本記事はGitHub Actions Advent Calendar 2020６日目の記事です。 今日は作ったGitHub Actions、auto-author-assignの紹介をしたいと思います。Pull Request（以下、PRと表記）を作成をしたとき、多くの場合そのPRの担当者（Assignee）はそのPR作者自身になるかと思います。 その「PR担当者をPR作者にアサインする」アクションを自動化した、というのが今回作成したGitHub Actionsになります。]]></summary><media:thumbnail xmlns:media="http://search.yahoo.com/mrss/" url="https://blog.toshimaru.net/images/posts/auto-author-assign/auto-author-assign.jpg" /><media:content medium="image" url="https://blog.toshimaru.net/images/posts/auto-author-assign/auto-author-assign.jpg" xmlns:media="http://search.yahoo.com/mrss/" /></entry><entry><title type="html">JekyllのGitHub PagesへのデプロイをGitHub Actionsを自動化する</title><link href="https://blog.toshimaru.net/jekyll-deploy-with-github-actions/" rel="alternate" type="text/html" title="JekyllのGitHub PagesへのデプロイをGitHub Actionsを自動化する" /><published>2020-06-22T00:00:00+09:00</published><updated>2020-06-22T00:00:00+09:00</updated><id>https://blog.toshimaru.net/jekyll-deploy-with-github-actions</id><content type="html" xml:base="https://blog.toshimaru.net/jekyll-deploy-with-github-actions/"><![CDATA[<p>Jekyll製<a href="https://blog.toshima.ru/">英語ブログ</a>のGitHub PagesへのデプロイをGitHub Actionsで自動化したのでそのメモ。</p>

<h2 id="今までのデプロイ方式">今までのデプロイ方式</h2>

<p>今までどうページソースをGitHub Pagesに自動デプロイしていたかでいうと、<a href="/autodeploy-jekyll/">Jekyllでgit pushをフックしてGithub Pagesへ自動デプロイ</a>するようにしていた。</p>

<p>この方法でも全く問題ないがセットアップがやや面倒。なので英語ブログは手動デプロイ状態のまま放置していた。今はGitHub Actionsを使ったデプロイ方式がナウそうだ、とのことで重い腰を上げてその方式をトライ。</p>

<h2 id="新しいデプロイ方式">新しいデプロイ方式</h2>

<p>対応したPull Request: <a href="https://github.com/toshimaru/blog.toshima.ru/pull/160">Deploy Automation with GitHub Actions · toshimaru/blog.toshima.ru</a></p>

<p>やっていることとしては至ってシンプル。</p>

<ul>
  <li>masterブランチで変更があった場合にActionをトリガー</li>
  <li><code class="language-plaintext highlighter-rouge">bundle install</code></li>
  <li><code class="language-plaintext highlighter-rouge">jekyll build</code></li>
  <li>生成した静的コンテンツのデータを<a href="https://github.com/peaceiris/actions-gh-pages">peaceiris/actions-gh-pages</a>を使って<code class="language-plaintext highlighter-rouge">gh-pages</code>ブランチにデプロイ</li>
</ul>

<h2 id="github-actions-configuration">GitHub Actions Configuration</h2>

<p>実際のyamlファイルの設定は下記の通り。</p>

<div class="language-yml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">on</span><span class="pi">:</span>
  <span class="na">push</span><span class="pi">:</span>
    <span class="na">branches</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="s">master</span>
<span class="na">jobs</span><span class="pi">:</span>
  <span class="na">gh-pages-deploy</span><span class="pi">:</span>
    <span class="na">runs-on</span><span class="pi">:</span> <span class="s">ubuntu-latest</span>
    <span class="na">steps</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="na">uses</span><span class="pi">:</span> <span class="s">actions/checkout@v2</span>
    <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">Set up Ruby</span>
      <span class="na">uses</span><span class="pi">:</span> <span class="s">actions/setup-ruby@v1</span>
      <span class="na">with</span><span class="pi">:</span>
        <span class="na">ruby-version</span><span class="pi">:</span> <span class="m">2.7</span>
    <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">bundle install</span>
      <span class="na">run</span><span class="pi">:</span> <span class="pi">|</span>
        <span class="s">bundle config set path 'vendor/bundle'</span>
        <span class="s">bundle install</span>
    <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">Jekyll Build</span>
      <span class="na">run</span><span class="pi">:</span> <span class="s">bundle exec jekyll build</span>
    <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">Deploy</span>
      <span class="na">uses</span><span class="pi">:</span> <span class="s">peaceiris/actions-gh-pages@v3</span>
      <span class="na">with</span><span class="pi">:</span>
        <span class="na">personal_token</span><span class="pi">:</span> <span class="s">${{ secrets.GITHUB_TOKEN }}</span>
        <span class="na">publish_dir</span><span class="pi">:</span> <span class="s">./_site</span>
</code></pre></div></div>

<h2 id="従来と比べて良い点">従来と比べて良い点</h2>

<p><code class="language-plaintext highlighter-rouge">gh-pages</code>ブランチにpushするにあたって<code class="language-plaintext highlighter-rouge">secrets.GITHUB_TOKEN</code> でトークンをセットするだけ。</p>]]></content><author><name>Toshimaru</name></author><category term="jekyll" /><category term="github" /><category term="ci" /><summary type="html"><![CDATA[Jekyll製英語ブログのGitHub PagesへのデプロイをGitHub Actionsで自動化したのでそのメモ。]]></summary><media:thumbnail xmlns:media="http://search.yahoo.com/mrss/" url="https://blog.toshimaru.net/images/posts/github-pages/action-gh-pages.png" /><media:content medium="image" url="https://blog.toshimaru.net/images/posts/github-pages/action-gh-pages.png" xmlns:media="http://search.yahoo.com/mrss/" /></entry><entry><title type="html">DependabotをGitHub公式Dependabotに移行させた</title><link href="https://blog.toshimaru.net/github-dependabot/" rel="alternate" type="text/html" title="DependabotをGitHub公式Dependabotに移行させた" /><published>2020-06-18T00:00:00+09:00</published><updated>2020-06-28T00:00:00+09:00</updated><id>https://blog.toshimaru.net/github-dependabot</id><content type="html" xml:base="https://blog.toshimaru.net/github-dependabot/"><![CDATA[<p><a href="https://dependabot.com/blog/hello-github/">2019年、DependabotがGitHubに買収された</a>ことはご存知の通り。</p>

<p>そのDependabotの機能が公式機能として取り込まれたということので早速移行してみた。</p>

<p><a href="https://github.blog/2020-06-01-keep-all-your-packages-up-to-date-with-dependabot/">Keep all your packages up to date with Dependabot - The GitHub Blog</a></p>

<h2 id="dependabot管理画面から簡単移行">Dependabot管理画面から簡単移行</h2>

<p>既存のDependabot管理画面から <code class="language-plaintext highlighter-rouge">Create config file</code>をクリック。</p>

<p><img src="/images/posts/github-dependabot/create-config.png" alt="config" /></p>

<h2 id="githubdependabotyml-作成"><code class="language-plaintext highlighter-rouge">.github/dependabot.yml</code> 作成</h2>

<p>するとdependabot-preview氏がPull Requestを自動的に作ってくれる。</p>

<p><img src="/images/posts/github-dependabot/pr.png" alt="pull request" /></p>

<p>via. <a href="https://github.com/toshimaru/auto-author-assign/pull/15">Create Dependabot config file by dependabot-preview · Pull Request #15 · toshimaru/auto-author-assign</a></p>

<p>yamlの内容は下記の通り。</p>

<div class="language-yml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">version</span><span class="pi">:</span> <span class="m">2</span>
<span class="na">updates</span><span class="pi">:</span>
<span class="pi">-</span> <span class="na">package-ecosystem</span><span class="pi">:</span> <span class="s">npm</span>
  <span class="na">directory</span><span class="pi">:</span> <span class="s2">"</span><span class="s">/"</span>
  <span class="na">schedule</span><span class="pi">:</span>
    <span class="na">interval</span><span class="pi">:</span> <span class="s">weekly</span>
    <span class="na">time</span><span class="pi">:</span> <span class="s1">'</span><span class="s">21:00'</span>
  <span class="na">open-pull-requests-limit</span><span class="pi">:</span> <span class="m">10</span>
  <span class="na">reviewers</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="s">toshimaru</span>
</code></pre></div></div>

<p>既存の設定をベースに自動的に内容を作成してくれた雰囲気。</p>

<h2 id="移行完了">移行完了</h2>

<p>PRをマージし、無事に移行が完了するとDependabot管理画面は下記のような表示となる。</p>

<p><img src="/images/posts/github-dependabot/finish.png" alt="done" /></p>

<p>下記の通りユーザー名は <code class="language-plaintext highlighter-rouge">dependabot-preview</code> <code class="language-plaintext highlighter-rouge">dependabot</code> へと変更されている。</p>

<p><img src="/images/posts/github-dependabot/commit-log.png" alt="log" /></p>

<p>新しいdependabotが作るPRはgithubの公式ロゴが入っている。</p>

<p><img src="/images/posts/github-dependabot/new-pr.png" alt="log" /></p>

<hr />

<p>余談だが<a href="https://github.blog/2019-06-17-github-acquires-pull-panda/">同年に買収されたPull Panda</a>のリマインダー機能もGitHubの公式機能に取り込まれている。</p>

<p><a href="https://help.github.com/en/github/setting-up-and-managing-organizations-and-teams/managing-scheduled-reminders-for-your-team">Managing scheduled reminders for your team - GitHub Help</a></p>

<p>良い機能がこのように＜買収→公式機能＞となっていくのは良い流れですね。</p>]]></content><author><name>Toshimaru</name></author><category term="github" /><category term="ci" /><summary type="html"><![CDATA[2019年、DependabotがGitHubに買収されたことはご存知の通り。 そのDependabotの機能が公式機能として取り込まれたということので早速移行してみた。 Keep all your packages up to date with Dependabot - The GitHub Blog]]></summary><media:thumbnail xmlns:media="http://search.yahoo.com/mrss/" url="https://blog.toshimaru.net/images/posts/github-dependabot/og.png" /><media:content medium="image" url="https://blog.toshimaru.net/images/posts/github-dependabot/og.png" xmlns:media="http://search.yahoo.com/mrss/" /></entry><entry><title type="html">reviewdogを使ってGitHub Actions上でRuboCop自動レビューを動かす</title><link href="https://blog.toshimaru.net/reviewdog-rubocop-github-actions/" rel="alternate" type="text/html" title="reviewdogを使ってGitHub Actions上でRuboCop自動レビューを動かす" /><published>2020-05-31T00:00:00+09:00</published><updated>2020-06-08T00:00:00+09:00</updated><id>https://blog.toshimaru.net/reviewdog-rubocop-github-actions</id><content type="html" xml:base="https://blog.toshimaru.net/reviewdog-rubocop-github-actions/"><![CDATA[<p>過去に<a href="/reviewdog-rubocop/">reviewdogを使ってCircleCI上でrubocop自動レビューを動かす記事</a>を書きました。</p>

<blockquote class="twitter-tweet"><p lang="ja" dir="ltr">Blogged. | reviewdogを使ってCI上でRuboCop自動レビューを動かす - Hack Your Design! <a href="https://t.co/8vdNUEIisX">https://t.co/8vdNUEIisX</a></p>&mdash; toshimaru (@toshimaru_e) <a href="https://twitter.com/toshimaru_e/status/1064661783594491904?ref_src=twsrc%5Etfw">November 19, 2018</a></blockquote>

<p>本記事はそれの<a href="https://github.com/features/actions">GitHub Actions</a>バージョンになります。</p>

<h2 id="なぜgithub-actionなのか">なぜGitHub Actionなのか？</h2>

<p>以前に書いた記事のようにCircleCIでも問題はないものの、GitHub ActionsはデフォルトでPull Requestにコメント可能な <code class="language-plaintext highlighter-rouge">GITHUB_TOKEN</code> を吐くことが可能で、そのへんのtoken周りの煩雑な設定が不要という点でCircleCIよりアドバンテージがあると言えます。</p>

<p><a href="https://help.github.com/en/actions/configuring-and-managing-workflows/authenticating-with-the-github_token">Authenticating with the GITHUB_TOKEN - GitHub Help</a></p>

<p>GitHubが公式機能として出していることもあり、GitHubとのIntegrationはGitHub Actionsのほうが優れている印象があります。</p>

<h2 id="基本のrubocop設定">基本のrubocop設定</h2>

<p>GitHub Actionsで動かす基本となるrubocop設定は下記の通りです。</p>

<p>※ 実際はbundlerのキャッシュの設定などが必要ですが今回は設定していません</p>

<div class="language-yml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># .github/workflows/rubocop.yml</span>
<span class="na">name</span><span class="pi">:</span> <span class="s">RuboCop</span>
<span class="na">on</span><span class="pi">:</span> <span class="pi">[</span><span class="nv">pull_request</span><span class="pi">]</span>
<span class="na">jobs</span><span class="pi">:</span>
  <span class="na">rubocop</span><span class="pi">:</span>
    <span class="na">runs-on</span><span class="pi">:</span> <span class="s">ubuntu-latest</span>
    <span class="na">steps</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="na">uses</span><span class="pi">:</span> <span class="s">actions/checkout@v2</span>
    <span class="pi">-</span> <span class="na">uses</span><span class="pi">:</span> <span class="s">actions/setup-ruby@v1</span>
      <span class="na">with</span><span class="pi">:</span>
        <span class="na">ruby-version</span><span class="pi">:</span> <span class="m">2.6</span>
    <span class="pi">-</span> <span class="na">run</span><span class="pi">:</span> <span class="pi">|</span>
        <span class="s">gem install bundler</span>
        <span class="s">bundle install</span>
    <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">Run rubocop</span>
      <span class="na">run</span><span class="pi">:</span> <span class="s">bundle exec rubocop</span>
</code></pre></div></div>

<p>上述の設定をベースにreviewdogを使った自動レビューの設定を追加していきます。</p>

<h2 id="reviewdogによる自動レビューを追加">reviewdogによる自動レビューを追加</h2>

<p>追加するのは下記の2ステップです。</p>

<ol>
  <li>Setup reviewdog: reviewdog のバイナリをインストール</li>
  <li>Run rubocop with reviewdog: rubocop の指摘を reviewdog に渡してPRコメントを付けさせる</li>
</ol>

<p>yamlファイルとしては下記になります。</p>

<div class="language-yml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># .github/workflows/rubocop.yml</span>
<span class="na">name</span><span class="pi">:</span> <span class="s">RuboCop</span>
<span class="na">on</span><span class="pi">:</span> <span class="pi">[</span><span class="nv">pull_request</span><span class="pi">]</span>
<span class="na">jobs</span><span class="pi">:</span>
  <span class="na">rubocop</span><span class="pi">:</span>
    <span class="na">runs-on</span><span class="pi">:</span> <span class="s">ubuntu-latest</span>
    <span class="na">steps</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="na">uses</span><span class="pi">:</span> <span class="s">actions/checkout@v2</span>
    <span class="pi">-</span> <span class="na">uses</span><span class="pi">:</span> <span class="s">actions/setup-ruby@v1</span>
      <span class="na">with</span><span class="pi">:</span>
        <span class="na">ruby-version</span><span class="pi">:</span> <span class="m">2.6</span>
    <span class="pi">-</span> <span class="na">run</span><span class="pi">:</span> <span class="pi">|</span>
        <span class="s">gem install bundler</span>
        <span class="s">bundle install</span>
    <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">Setup reviewdog</span>
      <span class="na">run</span><span class="pi">:</span> <span class="pi">|</span>
        <span class="s">mkdir -p $HOME/bin &amp;&amp; curl -sfL https://raw.githubusercontent.com/reviewdog/reviewdog/master/install.sh | sh -s -- -b $HOME/bin</span>
        <span class="s">echo ::add-path::$HOME/bin</span>
    <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">Run rubocop with reviewdog</span>
      <span class="na">env</span><span class="pi">:</span>
        <span class="na">REVIEWDOG_GITHUB_API_TOKEN</span><span class="pi">:</span> <span class="s">${{ secrets.GITHUB_TOKEN }}</span>
      <span class="na">run</span><span class="pi">:</span> <span class="s">bundle exec rubocop | reviewdog -reporter=github-pr-review -f=rubocop</span>
</code></pre></div></div>

<h2 id="レビューコメント">レビューコメント</h2>

<p>設定がうまくいっていれば、下記のように <code class="language-plaintext highlighter-rouge">github-actions</code> からの自動レビューコメントが付きます。</p>

<p><img src="/images/posts/rubocop-actions/rubocop-by-github-actions.png" alt="comment by github-actions" /></p>

<h2 id="実際に動かしてみたpull-request">実際に動かしてみたPull Request</h2>

<p>実際にこの構成で設定してみたPRは下記になります。</p>

<p><a href="https://github.com/toshimaru/Test/pull/16">rubocop x reviewdog x GitHub Actions by toshimaru · Pull Request #16 · toshimaru/Test</a></p>

<h2 id="余談">余談</h2>

<p>本記事ではミニマルな設定を紹介しましたが、実行高速化のために実際は下記の設定もあわせてしたほうが良いでしょう。</p>

<ul>
  <li>bundler cache の設定</li>
  <li>rubocop cache の設定（<code class="language-plaintext highlighter-rouge">~/.cache/rubocop_cache</code>）</li>
  <li><code class="language-plaintext highlighter-rouge">--parallel</code> オプションの追加</li>
</ul>]]></content><author><name>Toshimaru</name></author><category term="rubocop" /><category term="github" /><category term="ci" /><category term="review" /><summary type="html"><![CDATA[過去にreviewdogを使ってCircleCI上でrubocop自動レビューを動かす記事を書きました。 本記事はそれのGitHub Actionsバージョンになります。　GitHub Actions上でreviewdogを使ってRuboCop自動レビューを動かすための設定を紹介します。]]></summary><media:thumbnail xmlns:media="http://search.yahoo.com/mrss/" url="https://blog.toshimaru.net/images/posts/rubocop-actions/rubocop-actions.jpg" /><media:content medium="image" url="https://blog.toshimaru.net/images/posts/rubocop-actions/rubocop-actions.jpg" xmlns:media="http://search.yahoo.com/mrss/" /></entry><entry><title type="html">GitHub Actionsファーストインプレッション 〜v1との違い、導入方法、価格、良い点・悪い点〜</title><link href="https://blog.toshimaru.net/github-actions-first-impression/" rel="alternate" type="text/html" title="GitHub Actionsファーストインプレッション 〜v1との違い、導入方法、価格、良い点・悪い点〜" /><published>2019-08-20T00:00:00+09:00</published><updated>2020-05-31T00:00:00+09:00</updated><id>https://blog.toshimaru.net/github-actions-first-impression</id><content type="html" xml:base="https://blog.toshimaru.net/github-actions-first-impression/"><![CDATA[<p><a href="https://github.com/features/actions">GitHub Actions v2(beta)</a>が手元に降ってきたので試してみた記事です。</p>

<div class="warning">
  <h5></h5>
  <p>※まだBeta版なので本エントリに書いてある記述は古くなるなる可能性があります。最新情報は適宜公式ドキュメントを参照してください。</p>
</div>

<p>公式ドキュメント: <a href="https://help.github.com/en/actions/automating-your-workflow-with-github-actions">Automating your workflow with GitHub Actions - GitHub Help</a></p>

<h2 id="tldr">TL;DR</h2>

<ul>
  <li>GitHub Actions v2、間違いなく顧客が求めていたもの</li>
  <li>複雑なワークフロー組むにはちょっとまだバギーなので利用は控えとくのがよさげ（シンプルなものなら検討可）</li>
</ul>

<h2 id="実際に対応してみたpull-request">実際に対応してみたPull Request</h2>

<ul>
  <li><a href="https://github.com/toshimaru/nyan/pull/33">CI with GitHub Actions by toshimaru · Pull Request #33 · toshimaru/nyan</a></li>
  <li><a href="https://github.com/toshimaru/dotfiles/pull/75">GitHub Actions by toshimaru · Pull Request #75 · toshimaru/dotfiles</a></li>
</ul>

<h2 id="github-actions-v1-github-actions-v2がある">GitHub Actions v1, GitHub Actions v2がある</h2>

<p>まず注意点なのですが、GitHub ActionsにはGitHub社内的にGitHub Actions v1と呼ばれているものとGitHub Actions v2と呼ばれているものの２種類あります<sup id="fnref:1" role="doc-noteref"><a href="#fn:1" class="footnote" rel="footnote">1</a></sup>。</p>

<div class="info">
  <h5>追記</h5>
  <p>GitHub Actions v1がDeprecatedになったため、現在はv1の多くのコンテンツがv2の内容で置き換わってます。</p>
</div>

<p>それぞれ違いを下記に列挙します。</p>

<table>
  <thead>
    <tr>
      <th> </th>
      <th>GitHub Actions v1</th>
      <th>GitHub Actions v2</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>特徴</td>
      <td>汎用的なワークフロー型の<br />自動化ソリューション</td>
      <td>CI機能を備えた<br />自動化ソリューション</td>
    </tr>
    <tr>
      <td>記述言語</td>
      <td>HCL</td>
      <td>YAML(JS拡張可)</td>
    </tr>
    <tr>
      <td>公開ステータス</td>
      <td><del>2019年9月一杯でdeprecatedになる</del><br />Deprecated</td>
      <td>public beta<br />（順次ロールアウト中）</td>
    </tr>
    <tr>
      <td>ドキュメントURL</td>
      <td><del><a href="https://developer.github.com/actions/">developer.github.com</a></del><br />※現在アクセス不可</td>
      <td><a href="https://help.github.com/en/actions/automating-your-workflow-with-github-actions">help.github.com</a></td>
    </tr>
    <tr>
      <td>サポートOS</td>
      <td>Linux</td>
      <td>Linux/Mac/Windows</td>
    </tr>
    <tr>
      <td>環境設定</td>
      <td><code class="language-plaintext highlighter-rouge">Dockerfile</code>を自ら記述</td>
      <td>用意されたOSを選択して利用</td>
    </tr>
    <tr>
      <td>バックエンドインフラ</td>
      <td>?（おそらくGitHub Cloud?）</td>
      <td>Azure PipelinesのFork</td>
    </tr>
    <tr>
      <td>マーケットプレイス</td>
      <td><a href="https://github.com/marketplace?type=actions">GitHub Marketplace</a></td>
      <td><a href="https://github.com/marketplace?type=actions">GitHub Marketplace</a><br />※v1と同一URL</td>
    </tr>
  </tbody>
</table>

<p>２つあるので、「GitHub Actions」というキーワードでGoogle検索したときに古いv1の情報が出てくることもあるので注意してください。v1前提なのかv2前提なのかで全く内容が異なってきます。</p>

<p>またv1が手元で使えるからといってv2が自動的に使えるわけではありません。それぞれ別物なのでv1が使えてたとしても、v2が利用可能対象ユーザーとして降ってくるまでは使えません。</p>

<h2 id="導入方法">導入方法</h2>

<p>設定方法は簡単。GitHub Action v2が使える対象になっていれば、下記のように表示されますので <strong>Enable Repository</strong> してください。</p>

<p><img src="/images/posts/github-actions/enable.png" alt="Enable Repository" /></p>

<p>有効化されると、下記画面が出てくるのでGUIでポチポチワークフローを設定するもよし。</p>

<p><img src="/images/posts/github-actions/get-started.png" alt="Enable Repository 2" /></p>

<p><code class="language-plaintext highlighter-rouge">.github/workflows</code>以下に直接YAMLを置くもよし。動くYAMLサンプルは下記の公式 starter-workflows レポジトリを覗いてみるとよいかと思います。</p>

<p>Accelerating new GitHub Actions workflows:
<a href="https://github.com/actions/starter-workflows/tree/master/ci">https://github.com/actions/starter-workflows/tree/master/ci</a></p>

<h2 id="価格">価格</h2>

<p>気になる価格はどうでしょう。</p>

<p><img src="/images/posts/github-actions/price.png" alt="pricing" /></p>

<p>Public Repoは <strong>完全無料</strong>。並列数も <strong>20並列</strong> まで使える模様。</p>

<p>TravisCI, CircleCIと比較されることが多いかと思いますが、どちらのCIサービスも同じように無料で使えるものの並列数に制限があったり、CIジョブのキューイング・実行が遅かったりするので、今回のGitHub Actionsは完全にTravisCI, CircleCIを殺しにきたと言えるでしょう。</p>

<h2 id="良い点">良い点</h2>

<ul>
  <li>主要OSであるLinux/Mac/Windowsは<a href="https://help.github.com/en/articles/virtual-environments-for-github-actions#supported-virtual-environments">すべて対応</a></li>
  <li>イベントをhookしてからジョブが走り出すまでが早い</li>
  <li>GitHubサービス内で完結する
    <ul>
      <li>いろんなページを行ったり来たりしなくてよい</li>
    </ul>
  </li>
  <li>並列数がしっかり確保されている</li>
  <li><code class="language-plaintext highlighter-rouge">GITHUB_TOKEN</code>が自動的に発行される
    <ul>
      <li>外部CIサービスの場合、新たにTokenを払い出す必要があったので手間だった</li>
    </ul>
  </li>
  <li>GitHubとカジュアルに連携できるということで使い方の可能性は無限大…!!!
    <ul>
      <li>lintしてPRにコメント</li>
      <li>/x/path に変更あったら xxx のジョブ起動</li>
      <li>PR/Issueへの自動ラベリング</li>
      <li>Tagプッシュされたらリリース</li>
      <li>何らかの条件でIssueの作成/クローズ</li>
      <li>GitHubのコメントでチャットボット的な感覚でワークフロー呼び出し</li>
      <li>などなど
        <ul>
          <li><a href="https://github.com/marketplace?type=actions">Marketplace</a>や<a href="https://github.com/sdras/awesome-actions">awesome-actions</a>で良さげなものを探し見ると良さそう</li>
        </ul>
      </li>
    </ul>
  </li>
</ul>

<h2 id="悪い点">悪い点</h2>

<ul>
  <li><del>キャッシュ機構がない</del>
    <ul>
      <li><em>（追記）</em> きました: <a href="https://help.github.com/en/actions/automating-your-workflow-with-github-actions/caching-dependencies-to-speed-up-workflows">Caching dependencies to speed up workflows - GitHub Help</a></li>
    </ul>
  </li>
  <li>Slack通知が公式では用意されていない</li>
  <li><code class="language-plaintext highlighter-rouge">[ci skip]</code> 機能がない</li>
  <li>ドキュメントが少ない</li>
  <li><del>CI Status Badgeがない</del>
    <ul>
      <li><em>（追記）</em> CI Status Badgeに関して <a href="https://help.github.com/en/articles/configuring-a-workflow#adding-a-workflow-status-badge-to-your-repository">公式ドキュメント</a> に来ました</li>
    </ul>
  </li>
  <li><del>Betaなのでまだいろいろとバギー</del>
    <ul>
      <li><del>例: 公式の提供するAction（setup-go,setup-ruby）が一部うまく動いていなかったりする</del></li>
      <li><em>（追記）</em> だいぶ安定してきた感はあります</li>
    </ul>
  </li>
  <li><del>サポート問い合わせてもなかなか返信がこない（おそらくGitHubの中のサポート体制がまだ整っていない）</del>
    <ul>
      <li><em>（追記）</em> もうGitHubの中のサポート体制は整ったと思われるので、比較的返事も早く返ってくるようになった模様</li>
    </ul>
  </li>
  <li>eventの粒度がちょっと荒め？
    <ul>
      <li>例えば <code class="language-plaintext highlighter-rouge">create</code> イベントには Branch or Tag のcreateイベントが含まれるけど、ほしいのはtagのみの<code class="language-plaintext highlighter-rouge">tag_create</code>イベントなんだよなぁみたいなとき</li>
      <li>意図しないイベントを拾ったりする（branch deleteでイベントトリガーされるとか）</li>
    </ul>
  </li>
</ul>

<p>しかし今回のGitHub Actions as CI神機能をみんな使わないわけないので、上記の足りない点は近い将来（正式公開前くらいには）、大体直ると考えています。なので僕はGitHub Action as CIとしての機能強化はわりと楽観的にのんびり待っている感じです。</p>

<h2 id="結論">結論</h2>

<ul>
  <li>GitHub Actions v2、間違いなく顧客が求めていたものと言えます。オープンソースは基本はGitHub ActionsでCIを動かすことになっていくでしょう</li>
  <li>上述した悪い点が飲み込めて、沼る覚悟がある方はGitHub Actions v2が利用可能になった時点で導入を前向きに検討しても良いかもしれません。ただCircleCIなどで行っているような複雑なワークフローの移行は、まだ知見も少ない状況なのでなかなか大変な作業だと思います</li>
  <li>今後どんどん便利になって、いろんなバリエーションのActionもサポートされていくと思われるので、ガンガン使ってより良いCIライフにしましょう</li>
</ul>

<div class="footnotes" role="doc-endnotes">
  <ol>
    <li id="fn:1" role="doc-endnote">
      <p>GitHubのサポートの方がそのようにGitHub Actionsを呼び分けていました。 <a href="#fnref:1" class="reversefootnote" role="doc-backlink">&#8617;</a></p>
    </li>
  </ol>
</div>]]></content><author><name>Toshimaru</name></author><category term="github" /><category term="ci" /><summary type="html"><![CDATA[GitHub Actions v2(beta)が手元に降ってきたので試してみた記事です。 ※まだBeta版なので本エントリに書いてある記述は古くなるなる可能性があります。最新情報は適宜公式ドキュメントを参照してください。 TL;DR GitHub Actions v2、間違いなく顧客が求めていたもの 複雑なワークフロー組むにはちょっとまだバギーなので利用は控えとくのがよさげ（シンプルなものなら検討可） GitHub Actions v1, GitHub Actions v2がある まず注意点なのですが、GitHub ActionsにはGitHub社内的にGitHub Actions v1と呼ばれているものとGitHub Actions v2と呼ばれているものの２種類あります。それぞれ違いを下記に列挙します。]]></summary><media:thumbnail xmlns:media="http://search.yahoo.com/mrss/" url="https://blog.toshimaru.net/images/posts/github-actions/og.png" /><media:content medium="image" url="https://blog.toshimaru.net/images/posts/github-actions/og.png" xmlns:media="http://search.yahoo.com/mrss/" /></entry><entry><title type="html">reviewdogを使ってCI上でRuboCop自動レビューを動かす</title><link href="https://blog.toshimaru.net/reviewdog-rubocop/" rel="alternate" type="text/html" title="reviewdogを使ってCI上でRuboCop自動レビューを動かす" /><published>2018-11-19T00:00:00+09:00</published><updated>2020-06-08T00:00:00+09:00</updated><id>https://blog.toshimaru.net/reviewdog-rubocop</id><content type="html" xml:base="https://blog.toshimaru.net/reviewdog-rubocop/"><![CDATA[<p><a href="https://github.com/rubocop-hq/rubocop">rubocop</a>の自動レビューを<a href="https://github.com/haya14busa/reviewdog">reviewdog</a>を使ってやってみたのでその知見です。</p>

<ul id="markdown-toc">
  <li><a href="#追記" id="markdown-toc-追記">追記</a></li>
  <li><a href="#auto-rubocop-on-circleci-powered-by-reviewdog" id="markdown-toc-auto-rubocop-on-circleci-powered-by-reviewdog">Auto-RuboCop on CircleCI powered by reviewdog</a>    <ul>
      <li><a href="#1-configymlの設定" id="markdown-toc-1-configymlの設定">1. <code class="language-plaintext highlighter-rouge">config.yml</code>の設定</a></li>
      <li><a href="#2コメントできるtokenを取得--設定" id="markdown-toc-2コメントできるtokenを取得--設定">2.コメントできるTokenを取得 &amp; 設定</a></li>
      <li><a href="#3-rubucopの結果をreviewdogで通知" id="markdown-toc-3-rubucopの結果をreviewdogで通知">3. rubucopの結果をreviewdogで通知</a></li>
    </ul>
  </li>
  <li><a href="#完成yamlイメージ" id="markdown-toc-完成yamlイメージ">完成yamlイメージ</a></li>
  <li><a href="#なぜreviewdogなのか" id="markdown-toc-なぜreviewdogなのか">なぜreviewdogなのか</a></li>
  <li><a href="#最後に" id="markdown-toc-最後に">最後に</a></li>
  <li><a href="#参考資料" id="markdown-toc-参考資料">参考資料</a></li>
</ul>

<h2 id="追記">追記</h2>

<p>本記事の GitHub Actions 版を書きました。</p>

<blockquote class="twitter-tweet"><p lang="ja" dir="ltr">blogged. | reviewdogを使ってGitHub Actions上でRuboCop自動レビューを動かす - Hack Your Design! <a href="https://t.co/4u11iBjm6G">https://t.co/4u11iBjm6G</a></p>&mdash; toshimaru (@toshimaru_e) <a href="https://twitter.com/toshimaru_e/status/1267121968307814401?ref_src=twsrc%5Etfw">May 31, 2020</a></blockquote>

<h2 id="auto-rubocop-on-circleci-powered-by-reviewdog">Auto-RuboCop on CircleCI powered by reviewdog</h2>

<p>僕の作っているプロジェクトでrubocop自動レビューをCircleCI上で設定してみました。そのプルリクエストを見てもらうのが一番早いと思いますので、下記リンクより差分を確認してください。</p>

<p><a href="https://github.com/toshimaru/RailsTwitterClone/pull/254">https://github.com/toshimaru/RailsTwitterClone/pull/254</a></p>

<h3 id="1-configymlの設定">1. <code class="language-plaintext highlighter-rouge">config.yml</code>の設定</h3>

<p>基本的には<a href="https://github.com/haya14busa/reviewdog#circle-ci">公式READMEのCircleCIセットアップ手順</a>通りですが、まずは下記のようにreviewdogのバイナリを<code class="language-plaintext highlighter-rouge">curl</code>経由で落とします。</p>

<div class="language-yml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># 環境変数でダウンロードするreviewdogのバージョンを指定</span>
<span class="na">environment</span><span class="pi">:</span>
  <span class="na">REVIEWDOG_VERSION</span><span class="pi">:</span> <span class="s2">"</span><span class="s">0.9.11"</span>

<span class="c1"># reviewdogをcurlでダウンロード</span>
<span class="pi">-</span> <span class="na">run</span><span class="pi">:</span>
    <span class="na">name</span><span class="pi">:</span> <span class="s">Install reviewdog</span>
    <span class="na">command</span><span class="pi">:</span> <span class="pi">|</span>
      <span class="s">curl -fSL https://github.com/haya14busa/reviewdog/releases/download/$REVIEWDOG_VERSION/reviewdog_linux_amd64 -o reviewdog &amp;&amp; chmod +x ./reviewdog</span>
</code></pre></div></div>

<h3 id="2コメントできるtokenを取得--設定">2.コメントできるTokenを取得 &amp; 設定</h3>

<p>reviewdogにコメントさせるためにはコメントできる権限を持ったGitHub Tokenが必要になります。下記手順でGitHub Tokenを取得してください。</p>

<ul>
  <li><a href="https://github.com/settings/tokens">アクセストークンの取得ページ</a>にいく</li>
  <li>下記の権限を設定してTokenを発行
    <ul>
      <li>Privateレポジトリの設定: <code class="language-plaintext highlighter-rouge">repo</code>をチェック</li>
      <li>Publicレポジトリの設定: <code class="language-plaintext highlighter-rouge">public_repo</code>をチェック</li>
    </ul>
  </li>
</ul>

<p>これでTokenが発行できましたので、次にそのTokenの設定です。</p>

<ul>
  <li>CircleCIの環境変数の設定画面を開く</li>
  <li>下記の環境変数を設定
    <ul>
      <li><code class="language-plaintext highlighter-rouge">REVIEWDOG_GITHUB_API_TOKEN</code>の値に前手順で取得したTokenを設定</li>
    </ul>
  </li>
</ul>

<p>これにてreviewdogにコメントできる権限が付与されました。</p>

<h3 id="3-rubucopの結果をreviewdogで通知">3. rubucopの結果をreviewdogで通知</h3>

<p>あとはいつも通りのrubocopのコマンドをパイプしてreviewdogに渡してあげればOK。その際のオプションは <code class="language-plaintext highlighter-rouge">-f=rubocop</code>（rubocopフォーマット指定）, <code class="language-plaintext highlighter-rouge">-reporter=github-pr-review</code>（GitHub PRレビューコメント形式の指定） の２つを指定します。</p>

<div class="language-yml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="pi">-</span> <span class="na">run</span><span class="pi">:</span> <span class="s">bundle exec rubocop | ./reviewdog -f=rubocop -reporter=github-pr-review</span>
</code></pre></div></div>

<h2 id="完成yamlイメージ">完成yamlイメージ</h2>

<p><code class="language-plaintext highlighter-rouge">.circleci/config.yml</code>の完成イメージは下記です（完全なyamlファイル<a href="https://github.com/toshimaru/RailsTwitterClone/pull/254/files">当該Pull Request</a>より確認してください）。なおCircleCIはversion2.1を使用していることに注意してください（現時点の最新バージョン）。</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">version</span><span class="pi">:</span> <span class="m">2.1</span>
<span class="na">executors</span><span class="pi">:</span>
  <span class="na">default</span><span class="pi">:</span>
    <span class="na">working_directory</span><span class="pi">:</span> <span class="s">~/app</span>
    <span class="na">docker</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="na">image</span><span class="pi">:</span> <span class="s">circleci/ruby:2.5-node-browsers</span>
        <span class="na">environment</span><span class="pi">:</span>
          <span class="na">RAILS_ENV</span><span class="pi">:</span> <span class="s">test</span>
          <span class="na">REVIEWDOG_VERSION</span><span class="pi">:</span> <span class="s">0.9.11</span>
<span class="na">jobs</span><span class="pi">:</span>
  <span class="na">rubocop</span><span class="pi">:</span>
    <span class="na">executor</span><span class="pi">:</span>
      <span class="na">name</span><span class="pi">:</span> <span class="s">default</span>
    <span class="na">steps</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="s">checkout</span>
      <span class="pi">-</span> <span class="s">bundle_install</span>
      <span class="pi">-</span> <span class="na">run</span><span class="pi">:</span>
          <span class="na">name</span><span class="pi">:</span> <span class="s">Install reviewdog</span>
          <span class="na">command</span><span class="pi">:</span> <span class="pi">|</span>
            <span class="s">curl -fSL https://github.com/haya14busa/reviewdog/releases/download/$REVIEWDOG_VERSION/reviewdog_linux_amd64 -o reviewdog &amp;&amp; chmod +x ./reviewdog</span>
      <span class="pi">-</span> <span class="na">run</span><span class="pi">:</span> <span class="s">bundle exec rubocop | ./reviewdog -f=rubocop -reporter=github-pr-review</span>

<span class="na">workflows</span><span class="pi">:</span>
  <span class="na">test</span><span class="pi">:</span>
    <span class="na">jobs</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="s">...省略...</span>
</code></pre></div></div>

<h2 id="なぜreviewdogなのか">なぜreviewdogなのか</h2>

<p>ruboop自動レビューのための既にあるツールとしては、<a href="https://github.com/packsaddle/ruby-saddler">Saddler</a>や<a href="https://github.com/prontolabs/pronto">pronto</a>などがありますが、なぜそれらを使わずにreviewdogを採用したのかというと下記の理由からです。</p>

<ul>
  <li>Goのシングルバイナリポン置き（curlワンコマンド）でSetupがめちゃくちゃ楽</li>
  <li>Language Agnostic （Ruby以外もGo, PHP, Pythonなど他言語で使える）</li>
  <li>Go実装でパフォーマンスが良い</li>
  <li>Activeにメンテされている</li>
  <li>READMEドキュメントが充実している</li>
  <li>日本人が作っている！（おまけ理由</li>
</ul>

<h2 id="最後に">最後に</h2>

<p>本記事ではRubyプロジェクトのrubocop checkをreviewdogを使ってCircleCI上で動かす例を紹介しました。</p>

<p>公式READMEにはTravisCI上での動かし方であったり、GitHubの新機能・GitHub Checks形式での動かし方も記載されておりますので、興味があるかたは公式READMEをご参照ください。</p>

<h2 id="参考資料">参考資料</h2>

<ul>
  <li><a href="https://github.com/haya14busa/reviewdog">haya14busa/reviewdog</a></li>
  <li><a href="http://haya14busa.com/reviewdog/">reviewdog を飼ってコードレビューや開発を改善しませんか - haya14busa</a></li>
  <li><a href="https://qiita.com/azu/items/c563da0b5455a1b1dca2">reviewdogを使ってtextlintの結果をPull Requestに書き込む方法 - Qiita</a></li>
</ul>]]></content><author><name>Toshimaru</name></author><category term="review" /><category term="rubocop" /><category term="github" /><category term="circleci" /><category term="ci" /><summary type="html"><![CDATA[rubocopの自動レビューをreviewdogを使ってやってみたのでその知見です。 Auto-RuboCop on CircleCI powered by reviewdog 僕の作っているプロジェクトでrubocop自動レビューをCircleCI上で設定してみました。そのプルリクエストを見てもらうのが一番早いと思いますので、下記リンクより差分を確認してください。基本的には公式READMEのCircleCIセットアップ手順通りですが、まずは下記のようにreviewdogのバイナリをcurl経由で落とします。reviewdogにコメントさせるためにはコメントできる権限を持ったGitHub Tokenが必要になります。下記手順でGitHub Tokenを取得してください。]]></summary><media:thumbnail xmlns:media="http://search.yahoo.com/mrss/" url="https://blog.toshimaru.net/images/posts/rubocop_x_reviewdog.jpg" /><media:content medium="image" url="https://blog.toshimaru.net/images/posts/rubocop_x_reviewdog.jpg" xmlns:media="http://search.yahoo.com/mrss/" /></entry><entry><title type="html">GitHub + hubコマンドで快適な GitHub ライフを営む</title><link href="https://blog.toshimaru.net/github-and-hub/" rel="alternate" type="text/html" title="GitHub + hubコマンドで快適な GitHub ライフを営む" /><published>2013-11-28T00:00:00+09:00</published><updated>2021-03-01T00:00:00+09:00</updated><id>https://blog.toshimaru.net/github-and-hub</id><content type="html" xml:base="https://blog.toshimaru.net/github-and-hub/"><![CDATA[<p><code class="language-plaintext highlighter-rouge">github</code>で開発を進めている場合、<a href="https://github.com/github/hub">hubコマンド</a>の利用が素敵な感じです。</p>

<h2 id="インストール">インストール</h2>

<p>Macを使っていると<code class="language-plaintext highlighter-rouge">brew</code>使って<code class="language-plaintext highlighter-rouge">hub</code>コマンドが一発で入ります。</p>

<div class="language-console highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gp">$</span><span class="w"> </span>brew <span class="nb">install </span>hub
</code></pre></div></div>

<h2 id="gitのエイリアスをhubコマンドで拡張">gitのエイリアスをhubコマンドで拡張</h2>

<p>ただこのままだとhubコマンドはgitコマンドと分離しており少し不便なので、gitコマンドをhubコマンドで置き換えてやりましょう。もちろん既存のgitコマンドに悪影響を与えるようなことはありません。やり方は下記の１行を<code class="language-plaintext highlighter-rouge">.zshrc</code>なり<code class="language-plaintext highlighter-rouge">.bashrc</code>に追記すればOK.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">eval</span> <span class="s2">"</span><span class="si">$(</span>hub <span class="nb">alias</span> <span class="nt">-s</span><span class="si">)</span><span class="s2">"</span>
</code></pre></div></div>

<h2 id="githubからのcloneが楽になる">GitHubからのcloneが楽になる</h2>

<p>hubコマンドの導入によりGithubからのcloneが楽になります。下記のように<code class="language-plaintext highlighter-rouge">{user}/{repo}</code>でcloneできます。</p>

<div class="language-console highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gp">$</span><span class="w"> </span>git clone toshimaru/dotfiles
</code></pre></div></div>

<h2 id="github上の当該レポジトリのページを開く">GitHub上の当該レポジトリのページを開く</h2>

<p>自分の場合、GithubにpushしたあとにGithubのGUI上でDiffであったり諸々の状態を確認したいことがよくあります。<code class="language-plaintext highlighter-rouge">hub</code>コマンドであれば一発でいけます。</p>

<div class="language-console highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gp">$</span><span class="w"> </span>git browse
</code></pre></div></div>

<p>規定のブラウザで当該レポジトリのGithubページが開きます。</p>

<h2 id="その他">その他</h2>

<p>他にもpull-requestをコマンドから簡単に送れるようになったり嬉しいことがたくさんあります。詳しくは<a href="http://hub.github.com/">公式hubページ</a>を見てください。</p>]]></content><author><name>Toshimaru</name></author><category term="git" /><category term="github" /><summary type="html"><![CDATA[githubで開発を進めている場合、hubコマンドの利用が素敵な感じです。]]></summary></entry><entry><title type="html">Jekyllでgit pushをフックしてGithub Pagesへ自動デプロイするようにした</title><link href="https://blog.toshimaru.net/autodeploy-jekyll/" rel="alternate" type="text/html" title="Jekyllでgit pushをフックしてGithub Pagesへ自動デプロイするようにした" /><published>2013-11-15T00:00:00+09:00</published><updated>2020-06-22T00:00:00+09:00</updated><id>https://blog.toshimaru.net/autodeploy-jekyll</id><content type="html" xml:base="https://blog.toshimaru.net/autodeploy-jekyll/"><![CDATA[<p>本ブログはJekyllを使って構築しているのですが<code class="language-plaintext highlighter-rouge">git push</code>したときに<a href="https://travis-ci.org/">TravisCI</a>と連携してTravis上でビルドして<a href="https://pages.github.com/">Github Page</a>へとデプロイするように変更してみました。作業にあたっては下記ブログを参考にさせていただきました。</p>

<p><a href="http://pchw.github.io/blog/2013/06/27/octopress-travis/">OctopressとTravis CIを連携させてBlog生成を自動にする</a></p>

<p>上手順において２点、注意点があります。</p>

<ul>
  <li><code class="language-plaintext highlighter-rouge">brew install travis</code>でtravisコマンドはインストールできなくなっているっぽいので<code class="language-plaintext highlighter-rouge">gem install travis</code>で対応すること。</li>
  <li>上記では公開鍵暗号方式を使っているが、<a href="https://help.github.com/articles/creating-an-access-token-for-command-line-use">OAuth Access Tokens</a>を使ったほうが手間がかからなくて楽です。</li>
</ul>

<p>ということで公開鍵暗号方式ではなくOAuth Tokenを使うようにします。その場合は下記が参考になります。</p>

<p><a href="http://tricknotes.hateblo.jp/entry/2013/06/17/020229">Middleman で作った web サイトを Travis + GitHub pages でお手軽に運用する</a></p>

<h2 id="デプロイまでの流れ">デプロイまでの流れ</h2>

<p>デプロイまでの流れとしてはこんな感じです。</p>

<ol>
  <li>githubにエントリをpushする</li>
  <li>pushをフックしてTravisCI起動（事前にService HooksでTravisと連携するように設定してある）</li>
  <li>Travis上でスタティックサイトをビルド</li>
  <li>TravisからgithubへとToken通してpushする</li>
</ol>

<p>結果的に作成した<code class="language-plaintext highlighter-rouge">.travis.yml</code>,<code class="language-plaintext highlighter-rouge">Rakefile</code>はこんな感じです。</p>

<h2 id="travisyml">.travis.yml</h2>

<div class="language-rb highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="ss">sudo: </span><span class="kp">false</span>
<span class="ss">language: </span><span class="n">ruby</span>
<span class="ss">cache: </span><span class="n">bundler</span>
<span class="ss">rvm:
  </span><span class="o">-</span> <span class="mf">2.6</span><span class="o">.</span><span class="mi">3</span>

<span class="ss">before_install:
  </span><span class="o">-</span> <span class="n">gem</span> <span class="n">install</span> <span class="n">bundler</span>
<span class="ss">before_script:
  </span><span class="o">-</span> <span class="n">rake</span> <span class="n">setup</span>
<span class="ss">script:
  </span><span class="o">-</span> <span class="n">bundle</span> <span class="nb">exec</span> <span class="n">jekyll</span> <span class="n">build</span>
<span class="ss">after_success:
  </span><span class="o">-</span> <span class="p">.</span><span class="nf">/</span><span class="n">deploy</span><span class="p">.</span><span class="nf">bash</span>

<span class="ss">env:
  global:
    </span><span class="o">-</span> <span class="ss">secure: </span><span class="s2">"Gfz3Y4s2..."</span>
    <span class="o">-</span> <span class="no">GIT_COMMITTER_NAME</span><span class="o">=</span><span class="s2">"Toshimaru via TravisCI"</span>
    <span class="o">-</span> <span class="no">GIT_COMMITTER_EMAIL</span><span class="o">=</span><span class="s2">"me@toshimaru.net"</span>
    <span class="o">-</span> <span class="no">GIT_AUTHOR_NAME</span><span class="o">=</span><span class="s2">"Toshimaru via TravisCI"</span>
    <span class="o">-</span> <span class="no">GIT_AUTHOR_EMAIL</span><span class="o">=</span><span class="s2">"me@toshimaru.net"</span>
</code></pre></div></div>

<h2 id="rakefile">Rakefile</h2>

<div class="language-rb highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="no">REPOSITORY</span> <span class="o">=</span>
  <span class="k">if</span> <span class="no">ENV</span><span class="p">[</span><span class="s1">'GH_TOKEN'</span><span class="p">]</span>
    <span class="s1">'https://$GH_TOKEN@github.com/toshimaru/blog.toshimaru.net.git'</span>
  <span class="k">else</span>
    <span class="s1">'git@github.com:toshimaru/blog.toshimaru.net.git'</span>
  <span class="k">end</span>

<span class="n">define_method</span><span class="p">(</span><span class="ss">:build_jekyll_pages</span><span class="p">)</span> <span class="p">{</span> <span class="n">sh</span> <span class="s1">'bundle exec jekyll build'</span> <span class="p">}</span>
<span class="n">define_method</span><span class="p">(</span><span class="ss">:cleanup_deploy_dir</span><span class="p">)</span> <span class="p">{</span> <span class="n">sh</span> <span class="s1">'rm -rf _deploy/*'</span> <span class="p">}</span>
<span class="n">define_method</span><span class="p">(</span><span class="ss">:put_pages_into_deploy_dir</span><span class="p">)</span> <span class="p">{</span> <span class="n">sh</span> <span class="s1">'cp -R _site/* _deploy'</span> <span class="p">}</span>

<span class="n">desc</span> <span class="s1">'Clone blog repository to _deploy directory and checkout gh-pages branch'</span>
<span class="n">task</span> <span class="ss">:setup</span> <span class="k">do</span>
  <span class="n">sh</span> <span class="s1">'rm -rf  _deploy'</span>
  <span class="n">sh</span> <span class="s2">"git clone </span><span class="si">#{</span><span class="no">REPOSITORY</span><span class="si">}</span><span class="s2"> _deploy"</span>
  <span class="n">cd</span><span class="p">(</span><span class="s1">'_deploy'</span><span class="p">)</span> <span class="p">{</span> <span class="n">sh</span> <span class="s1">'git checkout gh-pages'</span> <span class="p">}</span>
<span class="k">end</span>

<span class="n">desc</span> <span class="s1">'deploy static pages to gh-pages automatically via Travis-CI'</span>
<span class="n">task</span> <span class="ss">:autodeploy</span> <span class="k">do</span>
  <span class="n">build_jekyll_pages</span>
  <span class="n">cleanup_deploy_dir</span>
  <span class="n">put_pages_into_deploy_dir</span>
  <span class="n">cd</span> <span class="s1">'_deploy'</span> <span class="k">do</span>
    <span class="n">sh</span> <span class="s1">'git add -A'</span>
    <span class="n">sh</span> <span class="s1">'git commit -m "Update via Travis"'</span>
    <span class="n">sh</span> <span class="s2">"git push --quiet </span><span class="si">#{</span><span class="no">REPOSITORY</span><span class="si">}</span><span class="s2"> gh-pages 2&gt; /dev/null"</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div></div>

<p>このように設定しておけばGitHub上のエディタだったり<a href="https://prose.io/">prose.io</a>みたいなサービス使ってWEB上でも記事を投稿できてグッドですね（実際はローカル上のエディタでの編集が慣れているのでWEB編集画面は使わないけど…）。</p>]]></content><author><name>Toshimaru</name></author><category term="github" /><category term="jekyll" /><summary type="html"><![CDATA[本ブログはJekyllを使って構築しているのですがgit pushしたときにTravis-CIと連携してTravis上でビルドしてGithub Pageへとデプロイするように変更してみました。]]></summary><media:thumbnail xmlns:media="http://search.yahoo.com/mrss/" url="https://blog.toshimaru.net/images/posts/github-pages/og.png" /><media:content medium="image" url="https://blog.toshimaru.net/images/posts/github-pages/og.png" xmlns:media="http://search.yahoo.com/mrss/" /></entry><entry><title type="html">初pull request がマージされました！</title><link href="https://blog.toshimaru.net/pull-request/" rel="alternate" type="text/html" title="初pull request がマージされました！" /><published>2012-09-16T00:00:00+09:00</published><updated>2012-09-16T00:00:00+09:00</updated><id>https://blog.toshimaru.net/pull-request</id><content type="html" xml:base="https://blog.toshimaru.net/pull-request/"><![CDATA[<p>githubを初めて一年ちょい（本格的に始めたのは３ヶ月前）、初めてのpull requestがマージされましたー。内容はしょっぼいバグ修正ですが嬉しいもんです。</p>

<p>ただmasterからpull requestを送ってしまいました...orz</p>
<blockquote>
<p>絶対にmasterブランチで作業してはいけません。また、masterブランチからpull requestを送るのもいけません。必ずpull requestのための別ブランチから送るようにしましょう。</p>
<p><a href="http://d.hatena.ne.jp/hnw/20110528">GitHubへpull requestする際のベストプラクティス</a></p>
</blockquote>
<p>いちおうpull requestのお作法もあるみたいですね。次回は別ブランチから送るようにします。</p>]]></content><author><name>Toshimaru</name></author><category term="git" /><category term="github" /><summary type="html"><![CDATA[githubを初めて一年ちょい（本格的に始めたのは３ヶ月前）、初めてのpull requestがマージされましたー。内容はしょっぼいバグ修正ですが嬉しいもんです。]]></summary><media:thumbnail xmlns:media="http://search.yahoo.com/mrss/" url="https://blog.toshimaru.net/images/2012/09/pullreq.png" /><media:content medium="image" url="https://blog.toshimaru.net/images/2012/09/pullreq.png" xmlns:media="http://search.yahoo.com/mrss/" /></entry><entry><title type="html">githubにgit pushした変更の取り消し</title><link href="https://blog.toshimaru.net/git-pushgithub/" rel="alternate" type="text/html" title="githubにgit pushした変更の取り消し" /><published>2012-09-10T00:00:00+09:00</published><updated>2012-09-10T00:00:00+09:00</updated><id>https://blog.toshimaru.net/git-pushgithub</id><content type="html" xml:base="https://blog.toshimaru.net/git-pushgithub/"><![CDATA[<p>「間違ったコミットをリモートにpushしちゃった！取り消したい！」ってときの操作。上イメージのようにgithubに誤ったpushをした場合を想定して解説してみます。</p>
<p>下記コマンド打つ。</p>
<div>
  <div class="code"><pre>$ git rebase -i HEAD~2</pre></div>
</div>

<p><code>HEAD~2</code>は「直前の２つのコミットを修正対象とする」という意味になります。３つ前のコミットを取り消したい場合は<code>HEAD~3</code>としてください。するとこんな画面が出てくる。</p>
<p><img src="/images/2012/09/gitterminal.png"></p>
<p>取り消したいコミットを削除して保存します。この場合、２行目のコミットが誤りなので２行目を削除して保存します。うまくいくとこんなメッセージ。</p>
<div>
  <div class="code"><pre>Successfully rebased and updated refs/heads/master.</pre></div>
</div>

<p>これで準備はOK。でも、その状態で普通にプッシュするとこんなエラーで受け付けてくれない。</p>
<div>
  <div class="code"><pre>$ git push
 ! [rejected]        master -&gt; master (non-fast-forward)
error: failed to push some refs to 'xxxx&quot;</pre></div>
</div>

<p>これは一度リモートにpushした変更を書き換えようとしているためにrejectされています。今回の場合、この変更は意図したものなので<code>-f</code>オプションを付けて強制的にpushします。</p>
<div>
  <div class="code"><pre>$ g push -f
+ 4f82199...2778ead master -&gt; master (forced update)</pre></div>
</div>

<p>以上になります。</p>

<h3>ローカルの変更を残したい場合...</h3>
<p>上手順を行うと、リモートの変更も失われますしローカル上の変更も失われます。ローカル上のコミットを残して、githubのpushを取り消したいときは下記のコマンド。</p>

<div>
  <div class="code"><pre>$ git push -f origin HEAD^:master
 + 91700fc...2778ead HEAD^ -&gt; master (forced update)</pre></div>
</div>

<p>上記の場合、<code>HEAD^</code>（最新の状態から１つ前の状態）へと強制pushしているので、最新コミットの１つがgithubから失われます。</p>

<h3>参考</h3>
<ul>
<li><a href="http://d.hatena.ne.jp/n7shi/20100204/1265382280">githubにpushしたcommitの取り消し</a></li>
</ul>]]></content><author><name>Toshimaru</name></author><category term="git" /><category term="github" /><summary type="html"><![CDATA[「間違ったコミットをリモートにpushしちゃった！取り消したい！」ってときの操作。上イメージのようにgithubに誤ったpushをした場合を想定して解説してみます。 下記コマンド打つ。 $ git rebase -i HEAD~2]]></summary><media:thumbnail xmlns:media="http://search.yahoo.com/mrss/" url="https://blog.toshimaru.net/images/2012/09/gitlog.png" /><media:content medium="image" url="https://blog.toshimaru.net/images/2012/09/gitlog.png" xmlns:media="http://search.yahoo.com/mrss/" /></entry></feed>